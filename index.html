<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Relatório de Turno</title>
    <meta name="theme-color" content="#f8fafc">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. ESTILOS GERAIS & TIPOGRAFIA
           ========================================= */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
            overscroll-behavior-y: none;
        }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* =========================================
           2. COMPONENTES UI (Cards, Inputs, Buttons)
           ========================================= */
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Inputs Padronizados */
        input[type="text"],
        input[type="date"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
            color: #1f2937;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        /* Botões Padronizados */
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:hover { background: #2563eb; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-secondary:hover { background: #4b5563; }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-danger:hover { background: #dc2626; }

        /* =========================================
           3. SIDEBAR & LAYOUT
           ========================================= */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: white;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e2e8f0;
        }

        .sidebar.closed { transform: translateX(-100%); }

        @media (min-width: 768px) {
            .sidebar { transform: translateX(0) !important; }
            .main-content { margin-left: 280px; }
        }

        /* =========================================
           4. BADGES DE TURNO
           ========================================= */
        .letter-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .letter-A { background: #ef4444; color: white; }
        .letter-B { background: #3b82f6; color: white; }
        .letter-C { background: #10b981; color: white; }
        .letter-D { background: #f59e0b; color: white; }
        .letter-ADM { background: #8b5cf6; color: white; }

        /* =========================================
           5. TOAST NOTIFICATIONS
           ========================================= */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid;
            pointer-events: auto;
            min-width: 300px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-color: #10b981; }
        .toast.error { border-color: #ef4444; }
        .toast.info { border-color: #3b82f6; }
        .toast.warning { border-color: #f59e0b; }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 14px;
        }

        .toast.success .toast-icon { background: #dcfce7; color: #16a34a; }
        .toast.error .toast-icon { background: #fee2e2; color: #dc2626; }
        .toast.info .toast-icon { background: #dbeafe; color: #2563eb; }
        .toast.warning .toast-icon { background: #fef3c7; color: #d97706; }

        /* =========================================
           6. LOADING OVERLAY
           ========================================= */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        /* =========================================
           7. AUTOCOMPLETE
           ========================================= */
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.1s;
        }
        
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: #eff6ff;
            color: #1e40af;
        }

        /* Animações Genéricas */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl border border-gray-100">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">Processando...</p>
        </div>
    </div>

    <script>
        // ============================================
        // 1. RECURSOS & CONFIGURAÇÃO
        // ============================================
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbzJleEMMQcZTKKjNmxCYURmyj-qtm3YggqUDkcUTfDTJ5xks7qRJsRu4x80T1GLJV6MUg/exec',
            PLANT: 'USIMINAS IPATINGA-MG B'
        };

        const ICONS = {
            login: '<svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            dashboard: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>',
            clipboard: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>',
            factory: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>',
            truck: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path></svg>',
            users: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
            user: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
            logout: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>',
            mapPin: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
            db: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>',
            pencil: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
            trash: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>',
            check: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            x: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            plus: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>',
            menu: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>',
            save: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>'
        };

        const SHIFT_LETTERS = ['A', 'B', 'C', 'D'];
        
        const SHIFT_TIMES = {
            'A': { start: '07:00', end: '19:00', hours: 12 },
            'B': { start: '19:00', end: '07:00', hours: 12 },
            'C': { start: '07:00', end: '19:00', hours: 12 },
            'D': { start: '19:00', end: '07:00', hours: 12 }
        };
        
        const BASE_DATES = {
            'A': new Date('2026-01-26T00:00:00'),
            'B': new Date('2026-01-30T00:00:00'),
            'C': new Date('2026-02-01T00:00:00'),
            'D': new Date('2026-01-28T00:00:00')
        };

        // ============================================
        // 2. UTILITÁRIOS & SISTEMA
        // ============================================
        
        // Cache System
        const Cache = {
            set(key, data) {
                try {
                    const item = { data: data, timestamp: Date.now() };
                    localStorage.setItem(`cache_${key}`, JSON.stringify(item));
                } catch (e) { console.warn('Cache set failed:', e); }
            },
            get(key) {
                try {
                    const item = localStorage.getItem(`cache_${key}`);
                    if (!item) return null;
                    const parsed = JSON.parse(item);
                    // 15 minutos de cache
                    if (Date.now() - parsed.timestamp > 15 * 60 * 1000) {
                        localStorage.removeItem(`cache_${key}`);
                        return null;
                    }
                    return parsed.data;
                } catch (e) { return null; }
            },
            clear() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cache_')) localStorage.removeItem(key);
                });
            }
        };

        // Toast System
        const Toast = {
            show(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = { success: '✓', error: '✕', info: 'i', warning: '!' };
                
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type]}</div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-gray-900">${message}</p>
                    </div>
                `;
                
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(20px)';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },
            success(m) { this.show(m, 'success'); },
            error(m) { this.show(m, 'error'); },
            info(m) { this.show(m, 'info'); },
            warning(m) { this.show(m, 'warning'); }
        };

        // Loading
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        // Navegação & History
        let navigationStack = [];
        
        function pushNavigation(view, data = {}) {
            navigationStack.push({ view: state.view });
            window.history.pushState({ view }, '', '');
            state.view = view;
            render();
        }

        window.addEventListener('popstate', (e) => {
            if (navigationStack.length > 0) {
                const previous = navigationStack.pop();
                state.view = previous.view;
                render();
            }
        });

        // ============================================
        // 3. ESTADO & LÓGICA DE NEGÓCIO
        // ============================================
        let state = {
            view: 'login',
            sidebarOpen: window.innerWidth >= 768,
            user: null,
            selectedDate: new Date().toISOString().split('T')[0],
            selectedLetter: null,
            equipamentos: [],
            vagas: [],
            equipe: [],
            reportItems: [],
            editingIndex: null,
            autocomplete: { active: null, selectedIndex: -1, filteredItems: [] }
        };

        // Helpers de Data
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
        }
        
        function getWeekday(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            return days[date.getDay()];
        }

        // Lógica de Turno
        function isWorkingDay(letter, targetDate) {
            const baseDate = BASE_DATES[letter];
            if (!baseDate) return false;
            const diffTime = targetDate.getTime() - baseDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const mod = ((diffDays % 8) + 8) % 8;
            return mod >= 4;
        }
        
        function getActiveLetters(dateStr) {
            const targetDate = new Date(dateStr + 'T00:00:00');
            return SHIFT_LETTERS.filter(letter => isWorkingDay(letter, targetDate));
        }

        function calculateShiftStatus(letter, startDate, days = 14) {
            const schedule = [];
            const start = new Date(startDate + 'T00:00:00');
            for (let i = 0; i < days; i++) {
                const current = new Date(start);
                current.setDate(current.getDate() + i);
                schedule.push({
                    day: current.getDate(),
                    weekday: getWeekday(current.toISOString().split('T')[0]),
                    working: isWorkingDay(letter, current)
                });
            }
            return schedule;
        }

        // ============================================
        // 4. API & AÇÕES
        // ============================================
        async function apiCall(endpoint, data = null) {
            try {
                const options = { method: data ? 'POST' : 'GET' };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) return Toast.warning('Preencha todos os campos');
            
            showLoading(true);
            const result = await apiCall(`${CONFIG.API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
            
            if (result.success) {
                state.user = result.user;
                localStorage.setItem('user', JSON.stringify(result.user));
                await loadOperationalData();
                state.view = 'main';
                Toast.success('Login realizado com sucesso!');
            } else {
                Toast.error('Credenciais inválidas');
            }
            showLoading(false);
            render();
        }

        async function loadOperationalData() {
            // Tenta cache primeiro
            const cached = Cache.get('opData');
            if (cached) {
                state.equipamentos = cached.equipamentos;
                state.vagas = cached.vagas;
                state.equipe = cached.equipe;
                return;
            }

            const result = await apiCall(`${CONFIG.API_URL}?action=getData&supervisor=${encodeURIComponent(state.user.nome)}`);
            if (result.success) {
                state.equipamentos = result.equipamentos || [];
                state.vagas = result.vagas || [];
                state.equipe = result.equipe || [];
                Cache.set('opData', { equipamentos: state.equipamentos, vagas: state.vagas, equipe: state.equipe });
            }
        }

        async function saveReport() {
            if (state.reportItems.length === 0) return Toast.warning('Adicione itens ao relatório');
            
            if (!confirm(`Confirmar envio de ${state.reportItems.length} itens?`)) return;
            
            showLoading(true);
            const reportData = {
                action: 'saveReport',
                date: state.selectedDate,
                supervisor: state.user.nome,
                shiftLetter: state.selectedLetter,
                generalObs: '',
                items: state.reportItems
            };
            
            const result = await apiCall(CONFIG.API_URL, reportData);
            
            if (result.success) {
                Toast.success('Relatório enviado com sucesso!');
                state.reportItems = [];
                state.editingIndex = null;
            } else {
                Toast.error('Erro ao enviar: ' + result.error);
            }
            showLoading(false);
            render();
        }

        // Lógica de Itens
        function addReportItem() {
            const vagaInput = document.getElementById('vaga');
            const equipInput = document.getElementById('equipamento');
            
            if (!vagaInput.dataset.vaga || !equipInput.dataset.placa) {
                return Toast.warning('Selecione Vaga e Equipamento via autocomplete');
            }

            const getMember = (id, role) => {
                const el = document.getElementById(id);
                return el.dataset.nome ? { role, name: el.dataset.nome, function: el.dataset.funcao } : null;
            };

            const crew = [
                getMember('motorista', 'Motorista'),
                getMember('operador1', 'Operador'),
                getMember('operador2', 'Operador')
            ].filter(Boolean);

            const item = {
                vaga: vagaInput.dataset.vaga,
                currentEquip: equipInput.dataset.placa,
                crew: crew,
                exchanges: [],
                area: 'Geral'
            };

            if (state.editingIndex !== null) {
                state.reportItems[state.editingIndex] = item;
                state.editingIndex = null;
                Toast.success('Item atualizado');
            } else {
                state.reportItems.push(item);
                Toast.success('Item adicionado');
            }

            // Reset inputs
            ['vaga', 'equipamento', 'motorista', 'operador1', 'operador2'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.value = ''; delete el.dataset.nome; delete el.dataset.vaga; delete el.dataset.placa; }
            });
            
            render();
        }

        function editReportItem(index) {
            const item = state.reportItems[index];
            state.editingIndex = index;
            render(); // Re-render to populate form
            
            setTimeout(() => {
                // Preencher form (precisa esperar o DOM)
                const setVal = (id, val, dataKey) => {
                    const el = document.getElementById(id);
                    if(el) { el.value = val; el.dataset[dataKey] = val; }
                };

                setVal('vaga', item.vaga, 'vaga');
                setVal('equipamento', item.currentEquip, 'placa');

                item.crew.forEach((m, i) => {
                    if (m.role === 'Motorista') {
                        const el = document.getElementById('motorista');
                        el.value = m.name; el.dataset.nome = m.name; el.dataset.funcao = m.function;
                    } else {
                        // Lógica simplificada para operadores
                        const opId = !document.getElementById('operador1').value ? 'operador1' : 'operador2';
                        const el = document.getElementById(opId);
                        el.value = m.name; el.dataset.nome = m.name; el.dataset.funcao = m.function;
                    }
                });
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
        }

        function removeReportItem(index) {
            if (confirm('Remover este item?')) {
                state.reportItems.splice(index, 1);
                render();
                Toast.info('Item removido');
            }
        }

        function handleLogout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('user');
                location.reload();
            }
        }

        function toggleSidebar() {
            state.sidebarOpen = !state.sidebarOpen;
            render();
        }

        function updateSelectedDate(val) {
            state.selectedDate = val;
            const active = getActiveLetters(val);
            // Se ADM, seleciona o primeiro ativo, senão mantém o do usuário se ativo
            if (state.user.letra === 'ADM' && active.length) state.selectedLetter = active[0];
            else if (state.user.letra !== 'ADM') state.selectedLetter = state.user.letra;
            render();
        }

        // ============================================
        // 5. RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else if (state.view === 'main') {
                app.innerHTML = `
                    <div class="flex min-h-screen bg-gray-50">
                        ${renderSidebar()}
                        <div class="main-content flex-1 flex flex-col min-w-0 transition-all duration-300">
                            ${renderHeader()}
                            <main class="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                                ${renderMainContent()}
                            </main>
                        </div>
                    </div>
                `;
                // Re-inicializa autocompletes após renderizar
                setTimeout(() => {
                    initAutocomplete('vaga', state.vagas.map(v => ({ vaga: v })), ['vaga']);
                    initAutocomplete('equipamento', state.equipamentos.map(e => ({ placa: e })), ['placa']);
                    const staff = state.equipe;
                    initAutocomplete('motorista', staff, ['nome', 'funcao']);
                    initAutocomplete('operador1', staff, ['nome', 'funcao']);
                    initAutocomplete('operador2', staff, ['nome', 'funcao']);
                }, 100);
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-blue-600 to-blue-800">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-fadeIn">
                        <div class="bg-blue-600 p-8 text-center">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg text-blue-600">
                                ${ICONS.factory}
                            </div>
                            <h1 class="text-2xl font-bold text-white mb-1">Sistema de Relatório</h1>
                            <p class="text-blue-100 text-sm font-medium opacity-90">${CONFIG.PLANT}</p>
                        </div>
                        
                        <form onsubmit="handleLogin(event)" class="p-8 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Usuário</label>
                                <input type="text" id="username" class="focus:ring-2 focus:ring-blue-500" required autocomplete="off">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Senha</label>
                                <input type="password" id="password" class="focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            
                            <button type="submit" class="w-full btn-primary justify-center">
                                ${ICONS.login} Acessar Sistema
                            </button>
                        </form>
                        
                        <div class="px-8 pb-6 text-center text-xs text-gray-400">
                            &copy; 2026 USIMINAS Ipatinga
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            const isGestao = state.user.nivel === 'gestao';
            
            return `
                ${state.sidebarOpen && window.innerWidth < 768 ? 
                    '<div class="fixed inset-0 bg-black/50 z-40 md:hidden animate-fadeIn" onclick="toggleSidebar()"></div>' : ''}
                
                <aside class="sidebar ${state.sidebarOpen ? '' : 'closed'}">
                    <div class="p-6 bg-white border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold text-lg">
                                ${state.user.nome.charAt(0)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-sm text-gray-900 truncate">${state.user.nome}</h3>
                                <p class="text-xs text-gray-500">${state.user.letra} | ${isGestao ? 'Gestão' : 'Supervisor'}</p>
                            </div>
                            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-gray-600">
                                ${ICONS.x}
                            </button>
                        </div>
                    </div>
                    
                    <nav class="p-4 space-y-1 flex-1 overflow-y-auto">
                        <button onclick="state.view='main'; render()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium bg-blue-50 text-blue-700">
                            ${ICONS.clipboard} Relatório de Turno
                        </button>
                        
                        ${isGestao ? `
                            <button class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                                ${ICONS.dashboard} Dashboard
                            </button>
                        ` : ''}

                        <div class="border-t border-gray-100 my-4 pt-4">
                            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Links</p>
                            <a href="#" class="block w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50">
                                ${ICONS.db} Banco de Dados
                            </a>
                            <a href="#" class="block w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50">
                                ${ICONS.users} Presença
                            </a>
                        </div>
                    </nav>

                    <div class="p-4 border-t border-gray-100">
                        <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium text-red-600 hover:bg-red-50 transition-colors">
                            ${ICONS.logout} Sair
                        </button>
                    </div>
                </aside>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm px-4 py-3 md:px-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleSidebar()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden">
                                ${ICONS.menu}
                            </button>
                            <h1 class="text-lg font-bold text-gray-900">Relatório de Turno</h1>
                        </div>
                        <div class="text-xs text-gray-500 font-mono hidden md:block">
                            ${formatDate(state.selectedDate)}
                        </div>
                    </div>
                </header>
            `;
        }

        function renderMainContent() {
            const activeLetters = getActiveLetters(state.selectedDate);
            const schedule = state.selectedLetter ? calculateShiftStatus(state.selectedLetter, state.selectedDate, 14) : [];
            const shiftInfo = SHIFT_TIMES[state.selectedLetter] || {start:'--', end:'--'};

            return `
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Painel de Controle -->
                    <div class="card p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Data de Referência</label>
                                <input type="date" value="${state.selectedDate}" onchange="updateSelectedDate(this.value)">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Turno Ativo</label>
                                <div class="flex items-center gap-2">
                                    ${state.user.letra === 'ADM' 
                                        ? activeLetters.map(l => `
                                            <button onclick="state.selectedLetter='${l}'; render()" 
                                                class="letter-badge letter-${l} ${state.selectedLetter === l ? 'ring-2 ring-offset-2 ring-blue-500' : 'opacity-70'}">
                                                ${l}
                                            </button>`).join('')
                                        : `<div class="letter-badge letter-${state.user.letra}">${state.user.letra}</div>`
                                    }
                                    ${state.selectedLetter ? `
                                        <div class="ml-2 text-sm text-gray-600">
                                            <span class="font-medium">Turno ${state.selectedLetter}</span> 
                                            <span class="text-gray-400">(${shiftInfo.start} - ${shiftInfo.end})</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        ${state.selectedLetter ? `
                            <div class="mt-6 pt-6 border-t border-gray-100">
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-3">Escala (Próximos 14 Dias)</label>
                                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">
                                    ${schedule.map(d => `
                                        <div class="flex flex-col items-center min-w-[50px] p-2 rounded-lg border ${d.working ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400'}">
                                            <span class="text-[10px] font-bold uppercase">${d.weekday}</span>
                                            <span class="text-lg font-bold">${d.day}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Formulário -->
                    <div class="card p-5 border-l-4 border-l-blue-500">
                        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                            ${state.editingIndex !== null ? ICONS.pencil : ICONS.plus}
                            ${state.editingIndex !== null ? 'Editar Lançamento' : 'Novo Lançamento'}
                        </h2>
                        
                        <form onsubmit="event.preventDefault(); addReportItem();" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="relative">
                                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Vaga / Posto</label>
                                    <input type="text" id="vaga" placeholder="Digite para buscar..." autocomplete="off">
                                </div>
                                <div class="relative">
                                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Equipamento</label>
                                    <input type="text" id="equipamento" placeholder="Digite a placa..." autocomplete="off">
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    ${ICONS.users} Equipe
                                </h3>
                                <div class="space-y-3">
                                    <div class="relative">
                                        <input type="text" id="motorista" placeholder="Buscar Motorista..." class="bg-white" autocomplete="off">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div class="relative"><input type="text" id="operador1" placeholder="Operador 1..." class="bg-white" autocomplete="off"></div>
                                        <div class="relative"><input type="text" id="operador2" placeholder="Operador 2..." class="bg-white" autocomplete="off"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-2">
                                ${state.editingIndex !== null ? `
                                    <button type="button" onclick="state.editingIndex=null; render()" class="flex-1 btn-secondary">Cancelar</button>
                                ` : ''}
                                <button type="submit" class="flex-1 btn-primary">
                                    ${state.editingIndex !== null ? 'Atualizar Item' : 'Adicionar Item'}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Itens -->
                    ${state.reportItems.length > 0 ? `
                        <div class="space-y-3 animate-fadeIn">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-gray-900 flex items-center gap-2">
                                    ${ICONS.clipboard} Itens Registrados (${state.reportItems.length})
                                </h3>
                            </div>
                            
                            ${state.reportItems.map((item, idx) => `
                                <div class="card p-4 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex flex-wrap gap-2 mb-2">
                                                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    ${ICONS.mapPin} ${item.vaga}
                                                </span>
                                                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    ${ICONS.truck} ${item.currentEquip}
                                                </span>
                                            </div>
                                            
                                            <div class="space-y-1 mt-3">
                                                ${item.crew.map(m => `
                                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                                        ${ICONS.user}
                                                        <span class="font-medium text-gray-900">${m.name}</span>
                                                        <span class="text-xs text-gray-400 border border-gray-200 rounded px-1">${m.role}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="flex gap-1 ml-4">
                                            <button onclick="editReportItem(${idx})" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                                ${ICONS.pencil}
                                            </button>
                                            <button onclick="removeReportItem(${idx})" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                                ${ICONS.trash}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                            <div class="text-gray-300 mb-3 mx-auto w-12 h-12">${ICONS.clipboard}</div>
                            <p class="text-gray-500 font-medium">Nenhum item adicionado ainda</p>
                        </div>
                    `}
                </div>

                <!-- Botão Flutuante Salvar -->
                ${state.reportItems.length > 0 ? `
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-40 md:pl-[280px]">
                        <div class="max-w-4xl mx-auto">
                            <button onclick="saveReport()" class="w-full btn-primary py-3 shadow-lg shadow-blue-500/20 text-lg">
                                ${ICONS.save} Enviar Relatório (${state.reportItems.length})
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ============================================
        // 6. AUTOCOMPLETE (LÓGICA)
        // ============================================
        function initAutocomplete(inputId, items, displayFields) {
            const input = document.getElementById(inputId);
            if (!input) return;

            const close = () => {
                const el = document.getElementById(inputId + '-dropdown');
                if (el) el.remove();
                state.autocomplete.active = null;
            };

            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                if (!term) return close();

                const filtered = items.filter(item => 
                    displayFields.some(field => String(item[field] || '').toLowerCase().includes(term))
                ).slice(0, 8); // Limit results

                state.autocomplete.active = inputId;
                state.autocomplete.filteredItems = filtered;

                // Render Dropdown
                let dropdown = document.getElementById(inputId + '-dropdown');
                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.id = inputId + '-dropdown';
                    dropdown.className = 'autocomplete-dropdown';
                    input.parentElement.appendChild(dropdown);
                }
                
                // Position logic
                dropdown.style.width = input.offsetWidth + 'px';
                dropdown.style.top = (input.offsetTop + input.offsetHeight) + 'px';
                dropdown.style.left = input.offsetLeft + 'px';

                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="p-3 text-sm text-gray-400 text-center">Nada encontrado</div>';
                    return;
                }

                dropdown.innerHTML = filtered.map(item => `
                    <div class="autocomplete-item">
                        <div class="font-medium text-gray-800">${item[displayFields[0]]}</div>
                        ${displayFields.length > 1 ? `<div class="text-xs text-gray-500">${item[displayFields[1]] || ''}</div>` : ''}
                    </div>
                `).join('');

                // Click event binding
                dropdown.querySelectorAll('.autocomplete-item').forEach((div, idx) => {
                    div.onclick = () => {
                        const selected = filtered[idx];
                        input.value = selected[displayFields[0]];
                        // Store all data in dataset
                        Object.keys(selected).forEach(k => input.dataset[k] = selected[k]);
                        close();
                    };
                });
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (state.autocomplete.active === inputId && !input.contains(e.target) && !e.target.closest('.autocomplete-dropdown')) {
                    close();
                }
            });
        }

        // ============================================
        // 7. INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                state.view = 'main';
                
                // Setup inicial do turno
                if (state.user.letra !== 'ADM') {
                    state.selectedLetter = state.user.letra;
                } else {
                    const active = getActiveLetters(state.selectedDate);
                    if (active.length) state.selectedLetter = active[0];
                }
                
                render();
                loadOperationalData(); // Background load
            } else {
                render();
            }
        });
    </script>
</body>
</html>
