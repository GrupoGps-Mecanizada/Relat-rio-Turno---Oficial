<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <!-- Meta tag para Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://apis.google.com https://*.googleusercontent.com https://script.google.com https://sheets.googleapis.com 'unsafe-inline' 'unsafe-eval'">
  <title>Sistema de Relatório de Turno v3.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Estilos inline para corrigir a cor da barra superior */
    .barra-superior {
      background-color: #0d47a1 !important; /* Azul escuro */
      color: white !important;
    }
    
    .botoes-direita {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .card-titulo {
      background-color: #0d47a1 !important; /* Azul escuro - mesma cor da barra */
      color: white !important;
    }
    
    /* Estilo para botões no header */
    .barra-superior .btn-outline-light {
      border-color: rgba(255, 255, 255, 0.5);
      color: white;
    }
    
    .barra-superior .btn-outline-light:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <div class="container app-container">
    <!-- BARRA SUPERIOR - CORRIGIDA -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center barra-superior">
        <h2 class="h5 mb-0"><i class="bi bi-clipboard-check-fill me-2"></i>Sistema de Relatório de Turno</h2>
        <div class="botoes-direita">
          <button class="btn btn-outline-light" id="dashboardTab" title="Dashboard">
            <i class="bi bi-graph-up"></i> <span class="d-none d-sm-inline">Dashboard</span>
          </button>
          <button class="btn btn-outline-light" id="btnPesquisar" title="Pesquisar Relatórios">
            <i class="bi bi-search"></i> <span class="d-none d-sm-inline">Pesquisar</span>
          </button>
          <button class="btn btn-outline-light" id="btnAjuda" title="Ajuda">
            <i class="bi bi-question-circle"></i> <span class="d-none d-sm-inline">Ajuda</span>
          </button>
          <button class="btn btn-outline-light" id="btnTema" title="Alternar Tema">
            <i class="bi bi-moon"></i> <span class="d-none d-sm-inline">Modo Escuro</span>
          </button>
        </div>
      </div>
    </div>

    <!-- INDICADORES DE ETAPA -->
    <div class="step-indicator d-none d-md-flex mb-4">
      <div id="step1Indicator" class="step-item active">
        <div class="step-number">1</div>
        <div class="step-title">Informações do Turno</div>
      </div>
      <div id="step2Indicator" class="step-item">
        <div class="step-number">2</div>
        <div class="step-title">Equipes</div>
      </div>
      <div id="step3Indicator" class="step-item">
        <div class="step-number">3</div>
        <div class="step-title">Revisão e Finalização</div>
      </div>
    </div>

    <!-- ETAPA 1: TURNO -->
    <div id="stepTurno" class="content-step" style="display: block;">
      <div class="card shadow-sm">
        <div class="card-header card-titulo">
          <h3 class="h5 mb-0">Etapa 1: Informações Básicas do Turno</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info alert-section mb-4" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Complete as informações básicas do turno antes de prosseguir.
          </div>

          <form id="formTurno" class="needs-validation" novalidate>
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="data" class="form-label">Data do turno <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="data" required>
                <div class="invalid-feedback">Por favor, informe a data do turno.</div>
              </div>
              <div class="col-md-6">
                <label for="horario" class="form-label">Horário do turno <span class="text-danger">*</span></label>
                <select class="form-select" id="horario" required>
                  <option value="" selected disabled>Selecione o horário</option>
                  <!-- Opções serão preenchidas via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o horário do turno.</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="letra" class="form-label">Letra do turno <span class="text-danger">*</span></label>
                <select class="form-select" id="letra" required>
                  <option value="" selected disabled>Selecione a letra</option>
                  <!-- Opções serão preenchidas via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione a letra do turno.</div>
              </div>
              <div class="col-md-6">
                <label for="supervisor" class="form-label">Supervisor responsável <span class="text-danger">*</span></label>
                <select class="form-select" id="supervisor" required>
                  <option value="" selected disabled>Selecione o supervisor</option>
                  <!-- Opções serão preenchidas via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o supervisor responsável.</div>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button type="button" class="btn btn-primary" id="btnAvancarEquipes">
                Próximo: Adicionar Equipes <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Outras etapas omitidas para brevidade -->
    <div id="stepEquipes" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="stepRevisao" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="stepSucesso" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="stepRelatorio" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="stepWhatsApp" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="stepPesquisa" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <div id="dashboard" class="content-step" style="display: none;">
      <!-- Conteúdo omitido -->
    </div>

    <footer class="text-center mt-4 mb-3 text-muted small">
      <hr class="my-3">
      <p class="mb-0">
        <i class="bi bi-code-slash me-1"></i>
        Desenvolvido por Warlison Abreu
        <span class="mx-1">•</span>
        v3.0
      </p>
    </footer>
  </div>

  <!-- Modais e outros componentes omitidos por brevidade -->

  <div class="loading" style="display: none;">
    <div class="loading-content">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <div class="loading-text mt-3">Processando, aguarde...</div>
    </div>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastNotificacao" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-check-circle-fill me-2"></i> <span id="toastTexto">Mensagem aqui</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>
  </div>

  <!-- Container para notificações -->
  <div id="notifications-container" class="notifications-container"></div>

  <!-- Bibliotecas externas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Scripts da aplicação na ordem correta -->
  <script src="js/config.js"></script>
  <script src="js/core/module-loader.js"></script>
  <script src="js/core/state.js"></script>
  <script src="js/core/cache-manager.js"></script>
  <script src="js/core/performance-monitor.js"></script>
  <script src="js/core/security.js"></script>
  <script src="js/ui/theme-manager.js"></script>
  <script src="js/ui/responsive-enhancements.js"></script>
  <script src="js/features/notifications.js"></script>
  <script src="js/features/dashboard.js"></script>
  <script src="js/auth/google-auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script src="js/main.js"></script>
  
  <!-- Script para corrigir os erros e configurar os event listeners -->
  <script>
    // Script para corrigir os problemas no carregamento
    document.addEventListener('DOMContentLoaded', function() {
      // 1. Definir URL da API se não estiver configurada
      if (!window.CONFIG || !CONFIG.API_URL) {
        console.warn("API_URL não configurada, definindo URL padrão");
        window.CONFIG = window.CONFIG || {};
        window.CONFIG.API_URL = 'https://script.google.com/macros/s/AKfycbw4LsriwJzmSwhljn9FSxLGvRIYo5FnOJIpJImlhLYbIg-MuVI2QQN4F6vdQ2BlEMgM/exec';
      }
      
      // 2. Configurar eventos para os botões em vez de usar onClick inline
      document.getElementById('btnPesquisar').addEventListener('click', function() {
        if (typeof abrirPesquisa === 'function') abrirPesquisa();
      });
      
      document.getElementById('btnAjuda').addEventListener('click', function() {
        if (typeof mostrarHelp === 'function') mostrarHelp();
      });
      
      document.getElementById('btnTema').addEventListener('click', function() {
        if (window.ModuleLoader && ModuleLoader.isInitialized('themeManager')) {
          const ThemeManager = ModuleLoader.get('themeManager');
          ThemeManager.toggleTheme();
          
          // Atualizar ícone e texto do botão
          const isDark = ThemeManager.isDark();
          this.innerHTML = isDark 
            ? '<i class="bi bi-sun"></i> <span class="d-none d-sm-inline">Modo Claro</span>'
            : '<i class="bi bi-moon"></i> <span class="d-none d-sm-inline">Modo Escuro</span>';
        }
      });
      
      document.getElementById('btnAvancarEquipes').addEventListener('click', function() {
        if (typeof avancarParaEquipes === 'function') avancarParaEquipes();
      });
      
      // 3. Configurar AppState caso não exista
      if (!window.AppState) {
        console.warn("AppState não encontrado, criando objeto básico de estado");
        window.AppState = {
          data: {},
          listeners: {},
          subscribe: function(key, callback) {
            if (!this.listeners[key]) this.listeners[key] = [];
            this.listeners[key].push(callback);
            return function() {
              this.listeners[key] = this.listeners[key].filter(cb => cb !== callback);
            }.bind(this);
          },
          update: function(key, value) {
            this.data[key] = value;
            if (this.listeners[key]) {
              this.listeners[key].forEach(callback => callback(value));
            }
          },
          get: function(key) {
            return this.data[key];
          }
        };
      }
      
      // 4. Definir opções padrão para dropdowns caso a API falhe
      const opcoesHorario = ['06:50 às 18:40', '18:40 às 06:50', 'ADM'];
      const opcoesLetra = ['A', 'B', 'C', 'D'];
      const opcoesSupervisor = ['Israel', 'Ozias', 'Wellison', 'Matozalém'];
      
      function popularSelect(elementId, opcoes) {
        const select = document.getElementById(elementId);
        if (!select) return;
        
        // Limpar opções existentes, mantendo a primeira (placeholder)
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // Adicionar novas opções
        opcoes.forEach(opcao => {
          const option = document.createElement('option');
          option.value = opcao;
          option.textContent = opcao;
          select.appendChild(option);
        });
      }
      
      // Preencher os selects com as opções padrão
      popularSelect('horario', opcoesHorario);
      popularSelect('letra', opcoesLetra);
      popularSelect('supervisor', opcoesSupervisor);
    });
  </script>
</body>
</html>
