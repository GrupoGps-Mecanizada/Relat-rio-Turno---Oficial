<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <title>Sistema de Relatório de Turno</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Custom styles -->
  <style>
    :root {
      --primary-color: #1e40af; /* Azul profissional */
      --secondary-color: #0f766e; /* Verde escuro */
      --danger-color: #be123c; /* Vermelho corporativo */
      --light-bg: #f8fafc; /* Fundo claro */
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--light-bg);
      color: #333;
      line-height: 1.6;
      padding-top: 20px;
      padding-bottom: 40px;
    }
    
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 25px;
      overflow: hidden;
    }
    
    .card-header {
      background-color: var(--primary-color);
      color: white;
      border-bottom: none;
      padding: 15px 20px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    .card-header h2 {
      font-size: 1.5rem;
      margin: 0;
    }
    
    .card-header h3 {
      font-size: 1.25rem;
      margin: 0;
    }
    
    .card-body {
      padding: 25px;
      background-color: white;
    }
    
    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #444;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(30, 64, 175, 0.25);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      padding: 8px 20px;
      font-weight: 500;
    }
    
    .btn-primary:hover, .btn-primary:focus {
      background-color: #1e3a8a;
      border-color: #1e3a8a;
    }
    
    .btn-success {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      padding: 8px 20px;
      font-weight: 500;
    }
    
    .btn-success:hover, .btn-success:focus {
      background-color: #0e6960;
      border-color: #0e6960;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
      padding: 8px 20px;
      font-weight: 500;
    }
    
    .btn-danger:hover, .btn-danger:focus {
      background-color: #a11035;
      border-color: #a11035;
    }
    
    .btn-tool {
      color: white;
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 4px 10px;
      border-radius: var(--border-radius);
      margin-left: 8px;
    }
    
    .btn-tool:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .equipe-card {
      border-left: 5px solid var(--primary-color);
      margin-bottom: 15px;
      transition: all 0.2s ease;
    }
    
    .equipe-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .equipe-vacuo {
      border-left: 5px solid var(--danger-color);
    }
    
    .equipe-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
    }
    
    .equipe-vacuo .card-header {
      background-color: var(--danger-color);
    }
    
    .badge-equipe {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 8px;
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-text {
      margin-top: 15px;
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .step-indicator {
      display: flex;
      margin-bottom: 30px;
      justify-content: space-between;
    }
    
    .step-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      position: relative;
      color: #6b7280;
    }
    
    .step-item:not(:last-child)::after {
      content: "";
      position: absolute;
      top: 50%;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: #e5e7eb;
      z-index: 1;
    }
    
    .step-number {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background-color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      position: relative;
      z-index: 2;
      font-weight: 500;
    }
    
    .step-title {
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .step-item.active {
      color: var(--primary-color);
    }
    
    .step-item.active .step-number {
      background-color: var(--primary-color);
      color: white;
    }
    
    .step-item.completed {
      color: var(--secondary-color);
    }
    
    .step-item.completed .step-number {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .step-item.completed::after {
      background-color: var(--secondary-color);
    }
    
    .alert-section {
      padding: 12px 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      border-left: 4px solid #3b82f6;
      background-color: #eff6ff;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .info-item {
      background-color: #f9fafb;
      padding: 12px;
      border-radius: var(--border-radius);
      border: 1px solid #e5e7eb;
    }
    
    .info-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-weight: 500;
      color: #1f2937;
    }
    
    .relatorio-text {
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      background-color: #f9fafb;
      padding: 20px;
      border-radius: var(--border-radius);
      border: 1px solid #e5e7eb;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .custom-tooltip {
      position: relative;
      display: inline-block;
    }
    
    .custom-tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .custom-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* WhatsApp style message */
    .whatsapp-message {
      background-color: #DCF8C6;
      border-radius: 10px;
      padding: 15px;
      border: 1px solid #ccc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Toast notification */
    .toast-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .toast-notification.show {
      opacity: 1;
    }
    
    /* Action buttons in search results */
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-buttons .btn {
      padding: 5px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @media (max-width: 768px) {
      .step-title {
        display: none;
      }
      
      .card-header h2 {
        font-size: 1.25rem;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.875rem;
      }
      
      .equipe-card .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .equipe-card .btn-group {
        margin-top: 10px;
        width: 100%;
        display: flex;
        justify-content: space-between;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      /* Melhorias mobile extras */
      .btn-group-vertical {
        width: 100%;
      }
      
      .modal-body {
        padding: 15px;
      }
      
      .modal-fullscreen .modal-body {
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }
      
      /* Botões maiores para facilitar o toque */
      .btn {
        min-height: 44px;
      }
      
      /* Tabelas responsivas em resultados de pesquisa */
      .table-responsive {
        overflow-x: auto;
      }
      
      /* Ajustar tamanho da área de texto para melhor visualização */
      .relatorio-text {
        max-height: 400px;
      }
      
      /* Melhorar a visualização de botões em grupos */
      .btn-group-sm {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .btn-group-sm .btn {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container app-container">
    <!-- Cabeçalho principal -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-clipboard-check me-2"></i>Sistema de Relatório de Turno</h2>
        <div>
          <button class="btn btn-tool" onclick="abrirPesquisa()">
            <i class="bi bi-search"></i> Pesquisar
          </button>
          <button class="btn btn-tool" onclick="mostrarHelp()">
            <i class="bi bi-question-circle"></i> Ajuda
          </button>
        </div>
      </div>
    </div>
    
    <!-- Indicador de etapas -->
    <div class="step-indicator d-none d-md-flex">
      <div id="step1Indicator" class="step-item active">
        <div class="step-number">1</div>
        <div class="step-title">Informações do Turno</div>
      </div>
      <div id="step2Indicator" class="step-item">
        <div class="step-number">2</div>
        <div class="step-title">Equipes</div>
      </div>
      <div id="step3Indicator" class="step-item">
        <div class="step-number">3</div>
        <div class="step-title">Revisão e Finalização</div>
      </div>
    </div>
    
    <!-- ETAPA 1: Informações básicas do turno -->
    <div id="stepTurno">
      <div class="card">
        <div class="card-header">
          <h3>Etapa 1: Informações Básicas do Turno</h3>
        </div>
        <div class="card-body">
          <div class="alert-section mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Complete as informações básicas do turno antes de prosseguir para o registro das equipes.
          </div>
          
          <form id="formTurno" class="needs-validation" novalidate>
            <div class="row mb-4">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="data" class="form-label">Data do turno *</label>
                <input type="date" class="form-control" id="data" required>
                <div class="invalid-feedback">Por favor, informe a data do turno.</div>
              </div>
              <div class="col-md-6">
                <label for="horario" class="form-label">Horário do turno *</label>
                <select class="form-select" id="horario" required>
                  <option value="" selected disabled>Selecione o horário</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o horário do turno.</div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="letra" class="form-label">Letra do turno *</label>
                <select class="form-select" id="letra" required>
                  <option value="" selected disabled>Selecione a letra</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione a letra do turno.</div>
              </div>
              <div class="col-md-6">
                <label for="supervisor" class="form-label">Supervisor responsável *</label>
                <select class="form-select" id="supervisor" required>
                  <option value="" selected disabled>Selecione o supervisor</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o supervisor responsável.</div>
              </div>
            </div>
            
            <div class="d-flex justify-content-end mt-4">
              <button type="button" class="btn btn-primary" onclick="avancarParaEquipes()">
                Próximo: Adicionar Equipes <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- ETAPA 2: Equipes do turno -->
    <div id="stepEquipes" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h3>Etapa 2: Equipes do Turno</h3>
        </div>
        <div class="card-body">
          <div class="alert-section mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Adicione as equipes que trabalharam durante este turno. É necessário adicionar pelo menos uma equipe.
          </div>
          
          <div class="d-flex flex-wrap gap-2 mb-4">
            <button type="button" class="btn btn-primary" onclick="adicionarEquipe('Alta Pressão')">
              <i class="bi bi-plus-circle me-2"></i> Adicionar Equipe Alta Pressão
            </button>
            <button type="button" class="btn btn-danger" onclick="adicionarEquipe('Auto Vácuo / Hiper Vácuo')">
              <i class="bi bi-plus-circle me-2"></i> Adicionar Equipe Vácuo/Hiper Vácuo
            </button>
          </div>
          
          <div id="listaEquipes" class="mb-4">
            <!-- As equipes serão adicionadas aqui dinamicamente -->
            <div class="alert alert-info text-center" id="semEquipes">
              <i class="bi bi-info-circle me-2"></i> Nenhuma equipe adicionada. Adicione pelo menos uma equipe para prosseguir.
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="voltarParaTurno()">
              <i class="bi bi-arrow-left me-2"></i> Voltar
            </button>
            <button type="button" class="btn btn-success" onclick="avancarParaRevisao()" id="btnAvancarRevisao" disabled>
              Revisar e Finalizar <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ETAPA 3: Revisão e finalização -->
    <div id="stepRevisao" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h3>Etapa 3: Revisão e Finalização</h3>
        </div>
        <div class="card-body">
          <div class="alert-section mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Revise todas as informações antes de salvar o relatório. Após salvar, não será possível editar o relatório.
          </div>
          
          <h4 class="mb-3">Informações do Turno</h4>
          <div class="info-grid mb-4" id="resumoTurno">
            <!-- Será preenchido dinamicamente -->
          </div>
          
          <h4 class="mb-3">Equipes</h4>
          <div id="resumoEquipes">
            <!-- Será preenchido dinamicamente -->
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="voltarParaEquipes()">
              <i class="bi bi-arrow-left me-2"></i> Voltar para Equipes
            </button>
            <button type="button" class="btn btn-success" onclick="salvarRelatorio()" id="btnSalvar">
              <i class="bi bi-save me-2"></i> Salvar Relatório
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ETAPA SUCESSO: Confirmação de salvamento -->
    <div id="stepSucesso" style="display: none;">
      <div class="card">
        <div class="card-header bg-success">
          <h3>Relatório Salvo com Sucesso</h3>
        </div>
        <div class="card-body text-center">
          <div class="mb-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
            <h4 class="mt-3">Relatório de Turno Salvo com Sucesso!</h4>
            <p class="text-muted">O relatório foi registrado e armazenado com segurança.</p>
          </div>
          
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Você pode acessar o relatório em diferentes formatos:
          </div>
          
          <div class="d-flex justify-content-center gap-3 flex-wrap mb-4">
            <button type="button" class="btn btn-primary" onclick="visualizarRelatorio()">
              <i class="bi bi-file-text me-2"></i> Visualizar Texto
            </button>
            <button type="button" class="btn btn-danger" onclick="gerarPDF()">
              <i class="bi bi-file-pdf me-2"></i> Gerar PDF
            </button>
            <button type="button" class="btn btn-success" onclick="exportarPlanilha()">
              <i class="bi bi-file-spreadsheet me-2"></i> Exportar Planilha
            </button>
            <button type="button" class="btn btn-info" onclick="formatarWhatsApp()">
              <i class="bi bi-whatsapp me-2"></i> Formato WhatsApp
            </button>
          </div>
          
          <button type="button" class="btn btn-secondary" onclick="novoRelatorio()">
            <i class="bi bi-plus-circle me-2"></i> Criar Novo Relatório
          </button>
        </div>
      </div>
    </div>
    
    <!-- VISUALIZAÇÃO: Relatório gerado em texto -->
    <div id="stepRelatorio" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h3>Relatório de Turno</h3>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <pre id="relatorioTexto" class="relatorio-text"></pre>
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="voltarParaSucesso()" id="btnVoltarRelatorio">
              <i class="bi bi-arrow-left me-2"></i> Voltar
            </button>
            <button type="button" class="btn btn-primary" onclick="copiarRelatorio()">
              <i class="bi bi-clipboard me-2"></i> Copiar Relatório
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- FORMATO WHATSAPP: Visualização formatada para WhatsApp -->
    <div id="stepWhatsApp" style="display: none;">
      <div class="card">
        <div class="card-header bg-info">
          <h3><i class="bi bi-whatsapp me-2"></i> Relatório Formato WhatsApp</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Este formato inclui emojis e formatações compatíveis com o WhatsApp.
            Copie o texto abaixo e cole diretamente no WhatsApp.
          </div>
          
          <div class="mb-4">
            <pre id="whatsAppTexto" class="relatorio-text" style="white-space: pre-wrap; background-color: #DCF8C6; border-radius: 10px; border: 1px solid #bbb; padding: 15px;"></pre>
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="voltarDoWhatsApp()" id="btnVoltarWhatsApp">
              <i class="bi bi-arrow-left me-2"></i> Voltar
            </button>
            <button type="button" class="btn btn-info" onclick="copiarWhatsApp()">
              <i class="bi bi-clipboard me-2"></i> Copiar para WhatsApp
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- PESQUISA DE RELATÓRIOS: Acesso a relatórios anteriores -->
    <div id="stepPesquisa" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h3><i class="bi bi-search me-2"></i> Pesquisar Relatórios</h3>
        </div>
        <div class="card-body">
          <div class="alert-section mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Pesquise relatórios anteriores por diferentes critérios.
          </div>
          
          <form id="formPesquisa" class="mb-4">
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="tipoPesquisa" class="form-label">Tipo de pesquisa</label>
                <select class="form-select" id="tipoPesquisa" onchange="ajustarCampoPesquisa()">
                  <option value="geral">Pesquisa Geral</option>
                  <option value="data">Por Data</option>
                  <option value="mes_ano">Por Mês/Ano</option>
                  <option value="supervisor">Por Supervisor</option>
                  <option value="letra">Por Letra do Turno</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="termoPesquisa" class="form-label" id="labelPesquisa">Termo de pesquisa</label>
                <input type="text" class="form-control" id="termoPesquisa">
              </div>
            </div>
            
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" onclick="voltarDaPesquisa()">
                <i class="bi bi-arrow-left me-2"></i> Voltar
              </button>
              <button type="button" class="btn btn-primary" onclick="executarPesquisa()">
                <i class="bi bi-search me-2"></i> Pesquisar
              </button>
            </div>
          </form>
          
          <div id="resultadosPesquisa" style="display: none;">
            <h4 class="mb-3">Resultados da Pesquisa</h4>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Horário</th>
                    <th>Letra</th>
                    <th>Supervisor</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="tabelaResultados">
                  <!-- Resultados serão adicionados aqui dinamicamente -->
                </tbody>
              </table>
            </div>
            
            <div class="alert alert-info" id="semResultados" style="display: none;">
              <i class="bi bi-info-circle me-2"></i>
              Nenhum resultado encontrado para sua pesquisa.
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rodapé com créditos -->
    <footer class="text-center mt-4 mb-2 text-muted">
      <hr class="my-3">
      <p class="mb-0">
        <i class="bi bi-code-slash me-1"></i>
        <strong>Desenvolvido por Warlison Abreu</strong> 
        <span class="mx-1">•</span> 
        <small>v2.2</small>
      </p>
    </footer>
  </div>
  
  <!-- MODAL: Formulário de equipe (atualizado) -->
  <div class="modal fade" id="modalEquipe" tabindex="-1" aria-labelledby="modalEquipeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" id="modalEquipeHeader">
          <h5 class="modal-title" id="modalEquipeLabel">Adicionar Equipe</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formEquipe" class="needs-validation" novalidate>
            <input type="hidden" id="equipeTipo">
            <input type="hidden" id="equipeIndex" value="-1">
            
            <!-- Dados básicos da equipe -->
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="equipeNumero" class="form-label">Número Da Equipe *</label>
                <select class="form-select" id="equipeNumero" required>
                  <option value="" selected disabled>Selecione o número</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o número da equipe.</div>
              </div>
              <div class="col-md-6">
                <label for="equipeIntegrantes" class="form-label">Nomes dos integrantes *</label>
                <input type="text" class="form-control" id="equipeIntegrantes" required>
                <div class="invalid-feedback">Por favor, informe os nomes dos integrantes.</div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="equipeArea" class="form-label">Área de atendimento *</label>
                <input type="text" class="form-control" id="equipeArea" required>
                <div class="invalid-feedback">Por favor, informe a área de atendimento.</div>
              </div>
              <div class="col-md-6">
                <label for="equipeAtividade" class="form-label">Atividade Realizada *</label>
                <input type="text" class="form-control" id="equipeAtividade" required>
                <div class="invalid-feedback">Por favor, informe a atividade realizada.</div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="equipeVaga" class="form-label">Vaga *</label>
                <select class="form-select" id="equipeVaga" required onchange="toggleVagaPersonalizada()">
                  <option value="" selected disabled>Selecione a vaga</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione a vaga.</div>
              </div>
              <div class="col-md-6" id="vagaPersonalizadaContainer" style="display: none;">
                <label for="equipeVagaPersonalizada" class="form-label">Especifique a vaga *</label>
                <input type="text" class="form-control" id="equipeVagaPersonalizada">
                <div class="invalid-feedback">Por favor, informe a vaga personalizada.</div>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="equipeEquipamento" class="form-label">Equipamento Utilizado *</label>
                <select class="form-select" id="equipeEquipamento" required onchange="toggleEquipamentoPersonalizado()">
                  <option value="" selected disabled>Selecione o equipamento</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
                <div class="invalid-feedback">Por favor, selecione o equipamento utilizado.</div>
              </div>
              <div class="col-md-6" id="equipamentoPersonalizadoContainer" style="display: none;">
                <label for="equipeEquipamentoPersonalizado" class="form-label">Especifique o equipamento *</label>
                <input type="text" class="form-control" id="equipeEquipamentoPersonalizado">
                <div class="invalid-feedback">Por favor, informe o equipamento personalizado.</div>
              </div>
            </div>
            
            <!-- Seção de troca de equipamento -->
            <div class="mb-3">
              <label class="form-label">Houve trocas de equipamentos? *</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="equipeTroca" id="equipeTrocaSim" value="Sim" onchange="toggleTrocaEquipamento()">
                <label class="form-check-label" for="equipeTrocaSim">Sim</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="equipeTroca" id="equipeTrocaNao" value="Não" checked onchange="toggleTrocaEquipamento()">
                <label class="form-check-label" for="equipeTrocaNao">Não</label>
              </div>
            </div>
            
            <div id="trocaDetalhes" style="display: none;">
              <hr>
              <h5 class="mb-3">Detalhes da Troca de Equipamento</h5>
              
              <div class="mb-3">
                <label class="form-label">Motivo da troca</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="equipeMotivoTroca" id="motivoCliente" value="Solicitação Do Cliente" onchange="toggleMotivoOutro()">
                  <label class="form-check-label" for="motivoCliente">Solicitação Do Cliente</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="equipeMotivoTroca" id="motivoDefeito" value="Defeitos Em Geral (Justificar)" onchange="toggleMotivoOutro()">
                  <label class="form-check-label" for="motivoDefeito">Defeitos Em Geral (Justificar)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="equipeMotivoTroca" id="motivoOutro" value="Outros Motivos (Justificar)" onchange="toggleMotivoOutro()">
                  <label class="form-check-label" for="motivoOutro">Outros Motivos (Justificar)</label>
                </div>
              </div>
              
              <div class="mb-3" id="motivoOutroContainer" style="display: none;">
                <label for="equipeMotivoOutro" class="form-label">Especifique o motivo</label>
                <input type="text" class="form-control" id="equipeMotivoOutro">
              </div>
              
              <div class="mb-3">
                <label for="equipeDefeito" class="form-label">Especifique o Defeito e as Medidas Tomadas</label>
                <textarea class="form-control" id="equipeDefeito" rows="3"></textarea>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipePlacaNova" class="form-label">Placa do novo equipamento</label>
                  <input type="text" class="form-control" id="equipePlacaNova">
                </div>
                <div class="col-md-6">
                  <label for="equipeDataHoraTroca" class="form-label">Data/Hora da troca</label>
                  <input type="text" class="form-control" id="equipeDataHoraTroca" placeholder="DD/MM/AAAA HH:MM">
                </div>
              </div>
            </div>
            
            <!-- Materiais utilizados - Alta Pressão -->
            <div id="materiaisAltaPressao">
              <hr>
              <h5 class="mb-3">Materiais Utilizados</h5>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Pistola</label>
                  <select class="form-select" id="equipePistola">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Pistola - Cano Longo</label>
                  <select class="form-select" id="equipePistolaCanoLongo">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Mangueira Torpedo/Torpedo</label>
                  <select class="form-select" id="equipeMangueiraTorpedo">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Pedal</label>
                  <select class="form-select" id="equipePedal">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Varetas</label>
                  <select class="form-select" id="equipeVaretas">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Rabicho</label>
                  <select class="form-select" id="equipeRabicho">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
              </div>
              
              <hr>
              <h5 class="mb-3">Quantidades</h5>
              
              <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                  <label for="equipeLancesMangueira" class="form-label">Lances De Mangueira</label>
                  <select class="form-select" id="equipeLancesMangueira">
                    <option value="N/A" selected>N/A</option>
                    <!-- Será preenchido dinamicamente via JavaScript -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="equipeLancesVaretas" class="form-label">Lances de Varetas</label>
                  <select class="form-select" id="equipeLancesVaretas">
                    <option value="N/A" selected>N/A</option>
                    <!-- Será preenchido dinamicamente via JavaScript -->
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Materiais utilizados - Vácuo -->
            <div id="materiaisVacuo" style="display: none;">
              <hr>
              <h5 class="mb-3">Materiais Utilizados</h5>
              
              <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                  <label class="form-label">Mangotes</label>
                  <select class="form-select" id="equipeMangotes">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Reduções</label>
                  <select class="form-select" id="equipeReducoes">
                    <option value="Sim">Sim</option>
                    <option value="N/A" selected>N/A</option>
                    <option value="Em Falta">Em Falta</option>
                  </select>
                </div>
              </div>
              
              <hr>
              <h5 class="mb-3">Quantidades de Mangotes</h5>
              
              <div class="row mb-3">
                <div class="col-md-4 mb-3 mb-md-0">
                  <label for="equipeMangotes3Polegadas" class="form-label">3 Polegadas</label>
                  <select class="form-select" id="equipeMangotes3Polegadas">
                    <option value="N/A" selected>N/A</option>
                    <!-- Será preenchido dinamicamente via JavaScript -->
                  </select>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                  <label for="equipeMangotes4Polegadas" class="form-label">4 Polegadas</label>
                  <select class="form-select" id="equipeMangotes4Polegadas">
                    <option value="N/A" selected>N/A</option>
                    <!-- Será preenchido dinamicamente via JavaScript -->
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="equipeMangotes6Polegadas" class="form-label">6 Polegadas</label>
                  <select class="form-select" id="equipeMangotes6Polegadas">
                    <option value="N/A" selected>N/A</option>
                    <!-- Será preenchido dinamicamente via JavaScript -->
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="equipeJustificativa" class="form-label">Justificativa Implementos em Falta</label>
              <textarea class="form-control" id="equipeJustificativa" rows="2"></textarea>
            </div>
            
            <hr>
            <h5 class="mb-3">Segurança</h5>
            
            <div class="mb-3">
              <label class="form-label">Utilizou caixa de bloqueio? *</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="equipeCaixaBloqueio" id="caixaBloqueioSim" value="Sim">
                <label class="form-check-label" for="caixaBloqueioSim">Sim</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="equipeCaixaBloqueio" id="caixaBloqueioNao" value="Não" checked>
                <label class="form-check-label" for="caixaBloqueioNao">Não</label>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="equipeCadeados" class="form-label">Quantidade de Cadeados</label>
                <select class="form-select" id="equipeCadeados">
                  <option value="N/A" selected>N/A</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="equipePlaquetas" class="form-label">Quantidade de Plaquetas</label>
                <select class="form-select" id="equipePlaquetas">
                  <option value="N/A" selected>N/A</option>
                  <!-- Será preenchido dinamicamente via JavaScript -->
                </select>
              </div>
            </div>
            
            <hr>
            <div class="mb-3">
              <label for="equipeObservacoes" class="form-label">Observações adicionais</label>
              <textarea class="form-control" id="equipeObservacoes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="salvarEquipe()">Salvar Equipe</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- MODAL: Ajuda -->
  <div class="modal fade" id="modalHelp" tabindex="-1" aria-labelledby="modalHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalHelpLabel"><i class="bi bi-question-circle me-2"></i>Ajuda do Sistema</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <h5>Como utilizar o Sistema de Relatório de Turno</h5>
          <p>Este sistema permite registrar as informações de turno e equipes de forma organizada e gerar relatórios padronizados.</p>
          
          <h6 class="mt-4">Etapa 1: Informações do Turno</h6>
          <p>Preencha os dados básicos do turno como data, horário, letra e supervisor responsável.</p>
          
          <h6 class="mt-3">Etapa 2: Equipes</h6>
          <p>Adicione todas as equipes que trabalharam no turno. Para cada equipe, você deverá preencher:</p>
          <ul>
            <li>Informações básicas da equipe (números, integrantes, área, atividade)</li>
            <li>Vaga e equipamento utilizado</li>
            <li>Informações sobre trocas de equipamento (se houver)</li>
            <li>Materiais utilizados</li>
            <li>Quantidades de lances e varetas (Alta Pressão) ou mangotes (Vácuo)</li>
            <li>Informações de segurança</li>
          </ul>
          
          <h6 class="mt-3">Etapa 3: Revisão e Finalização</h6>
          <p>Revise todas as informações antes de salvar. Após salvar, você poderá visualizar ou exportar o relatório em diferentes formatos:</p>
          <ul>
            <li><i class="bi bi-file-text"></i> <strong>Texto</strong> - Formato de texto básico para visualização</li>
            <li><i class="bi bi-file-pdf"></i> <strong>PDF</strong> - Documento formatado para impressão ou compartilhamento</li>
            <li><i class="bi bi-file-spreadsheet"></i> <strong>Planilha</strong> - Exportação para planilha do Google</li>
            <li><i class="bi bi-whatsapp"></i> <strong>WhatsApp</strong> - Formatação especial para envio via WhatsApp</li>
          </ul>
          
          <h6 class="mt-3">Pesquisa de Relatórios</h6>
          <p>É possível pesquisar relatórios anteriores usando o botão de pesquisa no topo da página. Você pode pesquisar por:</p>
          <ul>
            <li>Termo geral (busca em todos os campos)</li>
            <li>Data específica</li>
            <li>Mês/Ano</li>
            <li>Supervisor</li>
            <li>Letra do turno</li>
          </ul>
          
          <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Dica:</strong> Todos os campos marcados com * são obrigatórios.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- DIAGNÓSTICO: Área oculta (ativa com Ctrl+Shift+D) -->
  <div class="position-fixed bottom-0 end-0 p-3" id="diagnosticoArea" style="display: none;">
    <button class="btn btn-warning" onclick="executarDiagnostico()">
      <i class="bi bi-tools me-2"></i> Executar Diagnóstico
    </button>
  </div>
  
  <!-- Indicador de carregamento -->
  <div class="loading" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="loading-text mt-3">Processando, aguarde...</div>
  </div>
  
  <!-- Toast para notificações -->
  <div class="toast-notification" id="toastNotificacao">
    <i class="bi bi-check-circle me-2"></i> <span id="toastTexto"></span>
  </div>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variáveis globais
    let dadosFormulario = {};
    let equipes = [];
    let ultimoRelatorioId = null;
    let modalEquipe = null;
    let modalHelp = null;
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      // Detectar Brave
      async function detectBrave() {
        try {
          // Método para detectar o Brave
          const isBrave = navigator.userAgent.includes("Brave") || 
                         await Promise.race([
                           navigator.brave?.isBrave?.() || Promise.resolve(false),
                           new Promise(resolve => setTimeout(() => resolve(false), 100))
                         ]);
          
          if (isBrave) {
            // Criar banner de aviso
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
              <strong>Navegador Brave detectado!</strong> Para usar este sistema corretamente, 
              você precisa <u>desativar temporariamente</u> os Shields do Brave 
              (clique no ícone do escudo na barra de endereço e selecione "Shields are up").
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Inserir no topo da página
            const container = document.querySelector('.app-container');
            container.insertBefore(alertDiv, container.firstChild);
          }
        } catch (e) {
          console.error("Erro ao detectar navegador:", e);
        }
      }
      
      // Executar detecção
      detectBrave();

      // Inicializar modais
      try {
        modalEquipe = new bootstrap.Modal(document.getElementById('modalEquipe'));
        modalHelp = new bootstrap.Modal(document.getElementById('modalHelp'));
      } catch (err) {
        console.error("Erro ao inicializar modais:", err);
        // Tentar novamente após um pequeno atraso
        setTimeout(() => {
          try {
            modalEquipe = new bootstrap.Modal(document.getElementById('modalEquipe'));
            modalHelp = new bootstrap.Modal(document.getElementById('modalHelp'));
          } catch (e) {
            console.error("Falha ao inicializar modais mesmo após atraso:", e);
          }
        }, 500);
      }

      // Carregar dados do formulário
      carregarDadosFormulario();
      
      // Definir data de hoje como padrão
      document.getElementById('data').valueAsDate = new Date();
      
      // Configurar validação do Bootstrap
      configValidation();
      
      // Ativar botão de diagnóstico com Ctrl+Shift+D
      document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.shiftKey && event.key === 'D') {
          document.getElementById('diagnosticoArea').style.display = 'block';
        }
      });
      
      // Ajustar tamanho do modal para mobile
      const modalEquipeEl = document.getElementById('modalEquipe');
      if (window.innerWidth < 768) {
        modalEquipeEl.classList.add('modal-fullscreen');
      }
      
      // Detectar mudança de orientação
      window.addEventListener('resize', function() {
        if (window.innerWidth < 768) {
          modalEquipeEl.classList.add('modal-fullscreen');
        } else {
          modalEquipeEl.classList.remove('modal-fullscreen');
        }
      });
    });
    
    // Configuração da validação de formulários
    function configValidation() {
      'use strict';
      
      // Fetch all forms we want to apply validation styles to
      var forms = document.querySelectorAll('.needs-validation');
      
      // Loop over them and prevent submission
      Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    }
    
    // Funções para campos condicionais
    function toggleVagaPersonalizada() {
      const vagaSelect = document.getElementById('equipeVaga');
      const vagaPersonalizadaContainer = document.getElementById('vagaPersonalizadaContainer');
      const vagaPersonalizada = document.getElementById('equipeVagaPersonalizada');
      
      if (vagaSelect.value === 'OUTRA VAGA') {
        vagaPersonalizadaContainer.style.display = 'block';
        vagaPersonalizada.setAttribute('required', '');
      } else {
        vagaPersonalizadaContainer.style.display = 'none';
        vagaPersonalizada.removeAttribute('required');
      }
    }
    
    function toggleEquipamentoPersonalizado() {
      const equipamentoSelect = document.getElementById('equipeEquipamento');
      const equipamentoPersonalizadoContainer = document.getElementById('equipamentoPersonalizadoContainer');
      const equipamentoPersonalizado = document.getElementById('equipeEquipamentoPersonalizado');
      
      if (equipamentoSelect.value === 'OUTRO EQUIPAMENTO') {
        equipamentoPersonalizadoContainer.style.display = 'block';
        equipamentoPersonalizado.setAttribute('required', '');
      } else {
        equipamentoPersonalizadoContainer.style.display = 'none';
        equipamentoPersonalizado.removeAttribute('required');
      }
    }
    
    function toggleMotivoOutro() {
      const motivoOutro = document.getElementById('motivoOutro');
      const motivoOutroContainer = document.getElementById('motivoOutroContainer');
      
      if (motivoOutro && motivoOutro.checked) {
        motivoOutroContainer.style.display = 'block';
      } else {
        motivoOutroContainer.style.display = 'none';
      }
    }
    
    function toggleTrocaEquipamento() {
      const trocaSim = document.getElementById('equipeTrocaSim');
      const trocaDetalhes = document.getElementById('trocaDetalhes');
      
      if (trocaSim.checked) {
        trocaDetalhes.style.display = 'block';
      } else {
        trocaDetalhes.style.display = 'none';
        document.getElementById('motivoOutroContainer').style.display = 'none';
      }
    }
    
    // Funções para carregar dados
    function carregarDadosFormulario() {
      mostrarLoading('Carregando dados do formulário...');
      // Adicionar timeout e retry
      const maxTentativas = 3;
      let tentativa = 0;
      
      function tentarCarregar() {
        tentativa++;
        google.script.run
          .withSuccessHandler(preencherSelects)
          .withFailureHandler(function(erro) {
            console.error("Erro na tentativa " + tentativa + ": " + erro);
            if (tentativa < maxTentativas) {
              setTimeout(tentarCarregar, 1000); // Esperar 1 segundo antes de tentar novamente
            } else {
              tratarErro("Falha ao carregar dados após " + maxTentativas + " tentativas. Por favor, tente novamente ou use o Google Chrome.");
            }
          })
          .obterDadosFormulario();
      }
      
      tentarCarregar();
    }
    
    function preencherSelects(dados) {
      // Salvar dados para uso posterior
      dadosFormulario = dados;
      
      // Preencher horários
      const selectHorario = document.getElementById('horario');
      selectHorario.innerHTML = '<option value="" selected disabled>Selecione o horário</option>';
      dados.opcoesHorario.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectHorario.appendChild(option);
      });
      
      // Preencher letras
      const selectLetra = document.getElementById('letra');
      selectLetra.innerHTML = '<option value="" selected disabled>Selecione a letra</option>';
      dados.opcoesLetra.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectLetra.appendChild(option);
      });
      
      // Preencher supervisores
      const selectSupervisor = document.getElementById('supervisor');
      selectSupervisor.innerHTML = '<option value="" selected disabled>Selecione o supervisor</option>';
      dados.opcoesSupervisor.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectSupervisor.appendChild(option);
      });
      
      // Preencher números de equipe
      const selectNumeroEquipe = document.getElementById('equipeNumero');
      selectNumeroEquipe.innerHTML = '<option value="" selected disabled>Selecione o número</option>';
      dados.opcoesNumeroEquipe.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectNumeroEquipe.appendChild(option);
      });
      
      ocultarLoading();
    }
    
    // Função atualizada para mostrar/esconder campos por tipo de equipe
    function adicionarEquipe(tipo) {
      try {
        // Definir cor do cabeçalho do modal
        const modalHeader = document.getElementById('modalEquipeHeader');
        modalHeader.className = 'modal-header ' + (tipo === 'Auto Vácuo / Hiper Vácuo' ? 'bg-danger' : 'bg-primary');
        modalHeader.style.color = 'white';
        
        // Configurar título
        document.getElementById('modalEquipeLabel').textContent = 'Adicionar Equipe ' + tipo;
        document.getElementById('equipeTipo').value = tipo;
        document.getElementById('equipeIndex').value = '-1';
        
        // Resetar formulário e validação
        const form = document.getElementById('formEquipe');
        form.reset();
        form.classList.remove('was-validated');
        
        // Garantir que os radio buttons estejam no estado padrão
        document.getElementById('equipeTrocaNao').checked = true;
        document.getElementById('caixaBloqueioNao').checked = true;
        
        // Esconder containers condicionais
        document.getElementById('vagaPersonalizadaContainer').style.display = 'none';
        document.getElementById('equipamentoPersonalizadoContainer').style.display = 'none';
        document.getElementById('trocaDetalhes').style.display = 'none';
        document.getElementById('motivoOutroContainer').style.display = 'none';
        
        // Mostrar campos específicos por tipo de equipe
        if (tipo === 'Alta Pressão') {
          document.getElementById('materiaisAltaPressao').style.display = 'block';
          document.getElementById('materiaisVacuo').style.display = 'none';
        } else {
          document.getElementById('materiaisAltaPressao').style.display = 'none';
          document.getElementById('materiaisVacuo').style.display = 'block';
        }
        
        // Carregar opções corretas para o tipo de equipe
        atualizarOpcoesEquipe(tipo);
        
        // Mostrar o modal usando a instância bootstrap
        if (modalEquipe) {
          modalEquipe.show();
        } else {
          console.error("Modal não inicializado corretamente");
          // Tentar inicializar novamente o modal
          const modalElement = document.getElementById('modalEquipe');
          if (modalElement) {
            modalEquipe = new bootstrap.Modal(modalElement);
            modalEquipe.show();
          }
        }
      } catch (error) {
        console.error("Erro ao adicionar equipe:", error);
        alert("Erro ao abrir o formulário de equipe. Tente novamente.");
      }
    }
    
    // Função atualizada para carregar opções
    function atualizarOpcoesEquipe(tipo) {
      // Obter selects
      const selectVaga = document.getElementById('equipeVaga');
      const selectEquipamento = document.getElementById('equipeEquipamento');
      const selectLancesMangueira = document.getElementById('equipeLancesMangueira');
      const selectLancesVaretas = document.getElementById('equipeLancesVaretas');
      const selectCadeados = document.getElementById('equipeCadeados');
      const selectPlaquetas = document.getElementById('equipePlaquetas');
      
      // Limpar opções atuais
      selectVaga.innerHTML = '<option value="" selected disabled>Selecione a vaga</option>';
      selectEquipamento.innerHTML = '<option value="" selected disabled>Selecione o equipamento</option>';
      
      // Reset selects quantidades
      selectLancesMangueira.innerHTML = '<option value="N/A" selected>N/A</option>';
      selectLancesVaretas.innerHTML = '<option value="N/A" selected>N/A</option>';
      selectCadeados.innerHTML = '<option value="N/A" selected>N/A</option>';
      selectPlaquetas.innerHTML = '<option value="N/A" selected>N/A</option>';
      
      // Vácuo específicos
      const selectMangotes3 = document.getElementById('equipeMangotes3Polegadas');
      const selectMangotes4 = document.getElementById('equipeMangotes4Polegadas');
      const selectMangotes6 = document.getElementById('equipeMangotes6Polegadas');
      
      if (selectMangotes3) {
        selectMangotes3.innerHTML = '<option value="N/A" selected>N/A</option>';
        selectMangotes4.innerHTML = '<option value="N/A" selected>N/A</option>';
        selectMangotes6.innerHTML = '<option value="N/A" selected>N/A</option>';
      }
      
      // Adicionar novas opções com base no tipo
      let opcoesVaga, opcoesEquipamento;
      
      if (tipo === 'Alta Pressão') {
        opcoesVaga = dadosFormulario.vagasAltaPressao;
        opcoesEquipamento = dadosFormulario.equipamentosAltaPressao;
      } else {
        opcoesVaga = dadosFormulario.vagasVacuo;
        opcoesEquipamento = dadosFormulario.equipamentosVacuo;
      }
      
      // Preencher opções de vaga e equipamento
      opcoesVaga.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectVaga.appendChild(option);
      });
      
      opcoesEquipamento.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        selectEquipamento.appendChild(option);
      });
      
      // Preencher opções de lances (1-15)
      dadosFormulario.opcoesLances.forEach(opcao => {
        if (opcao !== 'N/A') {
          const option1 = document.createElement('option');
          option1.value = opcao;
          option1.textContent = opcao;
          selectLancesMangueira.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = opcao;
          option2.textContent = opcao;
          selectLancesVaretas.appendChild(option2);
        }
      });
      
      // Preencher opções de cadeados e plaquetas (1-30)
      dadosFormulario.opcoesCadeadosPlaquetas.forEach(opcao => {
        if (opcao !== 'N/A') {
          const option1 = document.createElement('option');
          option1.value = opcao;
          option1.textContent = opcao;
          selectCadeados.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = opcao;
          option2.textContent = opcao;
          selectPlaquetas.appendChild(option2);
        }
      });
      
      // Preencher opções de mangotes (1-10) se for Vácuo
      if (tipo === 'Auto Vácuo / Hiper Vácuo' && selectMangotes3) {
        dadosFormulario.opcoesMangotes.forEach(opcao => {
          if (opcao !== 'N/A') {
            const option1 = document.createElement('option');
            option1.value = opcao;
            option1.textContent = opcao;
            selectMangotes3.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = opcao;
            option2.textContent = opcao;
            selectMangotes4.appendChild(option2);
            
            const option3 = document.createElement('option');
            option3.value = opcao;
            option3.textContent = opcao;
            selectMangotes6.appendChild(option3);
          }
        });
      }
    }
    
    // Função atualizada para editar equipe
    function editarEquipe(index) {
      const equipe = equipes[index];
      
      // Definir cor do cabeçalho do modal
      const modalHeader = document.getElementById('modalEquipeHeader');
      modalHeader.className = 'modal-header ' + (equipe.tipo === 'Auto Vácuo / Hiper Vácuo' ? 'bg-danger' : 'bg-primary');
      modalHeader.style.color = 'white';
      
      document.getElementById('modalEquipeLabel').textContent = 'Editar Equipe ' + equipe.tipo;
      document.getElementById('equipeTipo').value = equipe.tipo;
      document.getElementById('equipeIndex').value = index;
      
      // Resetar validação
      document.getElementById('formEquipe').classList.remove('was-validated');
      
      // Mostrar campos específicos por tipo de equipe
      if (equipe.tipo === 'Alta Pressão') {
        document.getElementById('materiaisAltaPressao').style.display = 'block';
        document.getElementById('materiaisVacuo').style.display = 'none';
      } else {
        document.getElementById('materiaisAltaPressao').style.display = 'none';
        document.getElementById('materiaisVacuo').style.display = 'block';
      }
      
      // Carregar opções corretas para o tipo de equipe
      atualizarOpcoesEquipe(equipe.tipo);
      
      // Preencher o formulário com os dados da equipe
      document.getElementById('equipeNumero').value = equipe.numero;
      document.getElementById('equipeIntegrantes').value = equipe.integrantes;
      document.getElementById('equipeArea').value = equipe.area;
      document.getElementById('equipeAtividade').value = equipe.atividade;
      
      // Selecionar valores nos selects
      document.getElementById('equipeVaga').value = equipe.vaga;
      toggleVagaPersonalizada();
      if (equipe.vagaPersonalizada) {
        document.getElementById('equipeVagaPersonalizada').value = equipe.vagaPersonalizada;
      }
      
      document.getElementById('equipeEquipamento').value = equipe.equipamento;
      toggleEquipamentoPersonalizado();
      if (equipe.equipamentoPersonalizado) {
        document.getElementById('equipeEquipamentoPersonalizado').value = equipe.equipamentoPersonalizado;
      }
      
      // Configurar radiobuttons
      if (equipe.trocaEquipamento === 'Sim') {
        document.getElementById('equipeTrocaSim').checked = true;
        document.getElementById('trocaDetalhes').style.display = 'block';
        
        // Motivo da troca
        if (equipe.motivoTroca === 'Solicitação Do Cliente') {
          document.getElementById('motivoCliente').checked = true;
        } else if (equipe.motivoTroca === 'Defeitos Em Geral (Justificar)') {
          document.getElementById('motivoDefeito').checked = true;
        } else if (equipe.motivoTroca === 'Outros Motivos (Justificar)') {
          document.getElementById('motivoOutro').checked = true;
          document.getElementById('motivoOutroContainer').style.display = 'block';
          document.getElementById('equipeMotivoOutro').value = equipe.motivoOutro || '';
        }
        
        // Detalhes da troca
        document.getElementById('equipeDefeito').value = equipe.defeito || '';
        document.getElementById('equipePlacaNova').value = equipe.placaNova || '';
        document.getElementById('equipeDataHoraTroca').value = equipe.dataHoraTroca || '';
      } else {
        document.getElementById('equipeTrocaNao').checked = true;
        document.getElementById('trocaDetalhes').style.display = 'none';
      }
      
      // Materiais para Alta Pressão
      if (equipe.tipo === 'Alta Pressão') {
        document.getElementById('equipePistola').value = equipe.materiais?.pistola || 'N/A';
        document.getElementById('equipePistolaCanoLongo').value = equipe.materiais?.pistolaCanoLongo || 'N/A';
        document.getElementById('equipeMangueiraTorpedo').value = equipe.materiais?.mangueiraTorpedo || 'N/A';
        document.getElementById('equipePedal').value = equipe.materiais?.pedal || 'N/A';
        document.getElementById('equipeVaretas').value = equipe.materiais?.varetas || 'N/A';
        document.getElementById('equipeRabicho').value = equipe.materiais?.rabicho || 'N/A';
        
        // Lances
        document.getElementById('equipeLancesMangueira').value = equipe.lancesMangueira || 'N/A';
        document.getElementById('equipeLancesVaretas').value = equipe.lancesVaretas || 'N/A';
      } else if (equipe.materiaisVacuo) {
        // Materiais para Vácuo
        document.getElementById('equipeMangotes').value = equipe.materiaisVacuo.mangotes || 'N/A';
        document.getElementById('equipeReducoes').value = equipe.materiaisVacuo.reducoes || 'N/A';
        
        // Mangotes
        document.getElementById('equipeMangotes3Polegadas').value = equipe.mangotes3Polegadas || 'N/A';
        document.getElementById('equipeMangotes4Polegadas').value = equipe.mangotes4Polegadas || 'N/A';
        document.getElementById('equipeMangotes6Polegadas').value = equipe.mangotes6Polegadas || 'N/A';
      }
      
      // Justificativa
      document.getElementById('equipeJustificativa').value = equipe.justificativa || '';
      
      // Caixa de bloqueio
      if (equipe.caixaBloqueio === 'Sim') {
        document.getElementById('caixaBloqueioSim').checked = true;
      } else {
        document.getElementById('caixaBloqueioNao').checked = true;
      }
      
      // Cadeados e plaquetas
      document.getElementById('equipeCadeados').value = equipe.cadeados || 'N/A';
      document.getElementById('equipePlaquetas').value = equipe.plaquetas || 'N/A';
      
      // Observações
      document.getElementById('equipeObservacoes').value = equipe.observacoes || '';
      
      // Mostrar o modal
      try {
        if (modalEquipe) {
          modalEquipe.show();
        } else {
          // Tentar inicializar novamente
          modalEquipe = new bootstrap.Modal(document.getElementById('modalEquipe'));
          modalEquipe.show();
        }
      } catch (err) {
        console.error("Erro ao mostrar modal:", err);
        alert("Erro ao abrir o formulário de edição. Tente recarregar a página.");
      }
    }
    
    // Função atualizada para salvar equipe
    function salvarEquipe() {
      // Validar formulário
      const form = document.getElementById('formEquipe');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      // Coletar dados da equipe
      const tipo = document.getElementById('equipeTipo').value;
      const equipe = {
        tipo: tipo,
        numero: document.getElementById('equipeNumero').value,
        integrantes: document.getElementById('equipeIntegrantes').value,
        area: document.getElementById('equipeArea').value,
        atividade: document.getElementById('equipeAtividade').value,
        vaga: document.getElementById('equipeVaga').value,
        equipamento: document.getElementById('equipeEquipamento').value,
        trocaEquipamento: document.querySelector('input[name="equipeTroca"]:checked').value,
        caixaBloqueio: document.querySelector('input[name="equipeCaixaBloqueio"]:checked').value,
        cadeados: document.getElementById('equipeCadeados').value,
        plaquetas: document.getElementById('equipePlaquetas').value,
        observacoes: document.getElementById('equipeObservacoes').value,
        justificativa: document.getElementById('equipeJustificativa').value
      };
      
      // Campos personalizados
      if (equipe.vaga === 'OUTRA VAGA') {
        equipe.vagaPersonalizada = document.getElementById('equipeVagaPersonalizada').value;
      }
      
      if (equipe.equipamento === 'OUTRO EQUIPAMENTO') {
        equipe.equipamentoPersonalizado = document.getElementById('equipeEquipamentoPersonalizado').value;
      }
      
      // Dados específicos por tipo
      if (tipo === 'Alta Pressão') {
        equipe.materiais = {
          pistola: document.getElementById('equipePistola').value,
          pistolaCanoLongo: document.getElementById('equipePistolaCanoLongo').value,
          mangueiraTorpedo: document.getElementById('equipeMangueiraTorpedo').value,
          pedal: document.getElementById('equipePedal').value,
          varetas: document.getElementById('equipeVaretas').value,
          rabicho: document.getElementById('equipeRabicho').value
        };
        equipe.lancesMangueira = document.getElementById('equipeLancesMangueira').value;
        equipe.lancesVaretas = document.getElementById('equipeLancesVaretas').value;
      } else {
        equipe.materiaisVacuo = {
          mangotes: document.getElementById('equipeMangotes').value,
          reducoes: document.getElementById('equipeReducoes').value
        };
        equipe.mangotes3Polegadas = document.getElementById('equipeMangotes3Polegadas').value;
        equipe.mangotes4Polegadas = document.getElementById('equipeMangotes4Polegadas').value;
        equipe.mangotes6Polegadas = document.getElementById('equipeMangotes6Polegadas').value;
      }
      
      // Adicionar campos relacionados à troca de equipamentos, se aplicável
      if (equipe.trocaEquipamento === 'Sim') {
        const motivoTrocaEl = document.querySelector('input[name="equipeMotivoTroca"]:checked');
        equipe.motivoTroca = motivoTrocaEl ? motivoTrocaEl.value : '';
        
        if (equipe.motivoTroca === 'Outros Motivos (Justificar)') {
          equipe.motivoOutro = document.getElementById('equipeMotivoOutro').value;
        }
        
        equipe.defeito = document.getElementById('equipeDefeito').value;
        equipe.placaNova = document.getElementById('equipePlacaNova').value;
        equipe.dataHoraTroca = document.getElementById('equipeDataHoraTroca').value;
      }
      
      // Verificar se estamos editando ou adicionando
      const index = parseInt(document.getElementById('equipeIndex').value);
      if (index >= 0) {
        // Editar equipe existente
        equipes[index] = equipe;
      } else {
        // Adicionar nova equipe
        equipes.push(equipe);
      }
      
      // Atualizar a listagem de equipes
      atualizarListaEquipes();
      
      // Fechar o modal usando a instância do Bootstrap
      try {
        if (modalEquipe) {
          modalEquipe.hide();
        } else {
          // Tentar fechar de outra forma
          const modalElement = document.getElementById('modalEquipe');
          if (modalElement && typeof bootstrap !== 'undefined') {
            bootstrap.Modal.getInstance(modalElement)?.hide();
          }
        }
      } catch (error) {
        console.error("Erro ao fechar modal:", error);
        // Tentar fechar de forma alternativa
        document.querySelector('.modal-backdrop')?.remove();
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
      
      // Atualizar botão de avançar
      atualizarBotaoAvancar();
      
      // Limpar o formulário e remover a validação
      setTimeout(() => {
        form.reset();
        form.classList.remove('was-validated');
      }, 100);
      
      // Mostrar notificação
      mostrarNotificacao('Equipe salva com sucesso!');
    }
    
    function removerEquipe(index) {
      if (confirm('Tem certeza que deseja remover esta equipe?')) {
        equipes.splice(index, 1);
        atualizarListaEquipes();
        atualizarBotaoAvancar();
        mostrarNotificacao('Equipe removida com sucesso!');
      }
    }
    
    // Navegação entre etapas
    function avancarParaEquipes() {
      // Validar formulário
      const form = document.getElementById('formTurno');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      // Coletar dados do turno
      const dadosTurno = {
        data: document.getElementById('data').value,
        horario: document.getElementById('horario').value,
        letra: document.getElementById('letra').value,
        supervisor: document.getElementById('supervisor').value
      };
      
      // Salvar dados
      window.dadosTurno = dadosTurno;
      
      // Atualizar indicadores de etapa
      document.getElementById('step1Indicator').classList.remove('active');
      document.getElementById('step1Indicator').classList.add('completed');
      document.getElementById('step2Indicator').classList.add('active');
      
      // Avançar para próxima etapa
      document.getElementById('stepTurno').style.display = 'none';
      document.getElementById('stepEquipes').style.display = 'block';
      
      // Atualizar botão de avançar
      atualizarBotaoAvancar();
    }
    
    function voltarParaTurno() {
      // Atualizar indicadores de etapa
      document.getElementById('step1Indicator').classList.add('active');
      document.getElementById('step1Indicator').classList.remove('completed');
      document.getElementById('step2Indicator').classList.remove('active');
      
      // Voltar para etapa anterior
      document.getElementById('stepEquipes').style.display = 'none';
      document.getElementById('stepTurno').style.display = 'block';
    }
    
    function avancarParaRevisao() {
      // Verificar se há equipes
      if (equipes.length === 0) {
        alert('Adicione pelo menos uma equipe antes de prosseguir.');
        return;
      }
      
      // Atualizar indicadores de etapa
      document.getElementById('step2Indicator').classList.remove('active');
      document.getElementById('step2Indicator').classList.add('completed');
      document.getElementById('step3Indicator').classList.add('active');
      
      // Gerar resumo do turno
      const resumoTurno = document.getElementById('resumoTurno');
      resumoTurno.innerHTML = `
        <div class="info-item">
          <div class="info-label">Data</div>
          <div class="info-value">${formatarData(window.dadosTurno.data)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Horário</div>
          <div class="info-value">${window.dadosTurno.horario}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Letra</div>
          <div class="info-value">${window.dadosTurno.letra}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Supervisor</div>
          <div class="info-value">${window.dadosTurno.supervisor}</div>
        </div>
      `;
      
      // Gerar resumo das equipes
      const resumoEquipes = document.getElementById('resumoEquipes');
      resumoEquipes.innerHTML = '';
      
      equipes.forEach((equipe, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-3 ' + (equipe.tipo === 'Auto Vácuo / Hiper Vácuo' ? 'border-danger' : 'border-primary');
        
        const header = document.createElement('div');
        header.className = 'card-header ' + (equipe.tipo === 'Auto Vácuo / Hiper Vácuo' ? 'bg-danger' : 'bg-primary');
        header.style.color = 'white';
        header.textContent = `${equipe.tipo} - ${equipe.numero}`;
        
        const body = document.createElement('div');
        body.className = 'card-body';
        
        // Principais informações
        const principaisInfo = document.createElement('div');
        principaisInfo.className = 'row mb-3';
        principaisInfo.innerHTML = `
          <div class="col-md-6">
            <p><strong>Integrantes:</strong> ${equipe.integrantes}</p>
            <p><strong>Área:</strong> ${equipe.area}</p>
            <p><strong>Atividade:</strong> ${equipe.atividade}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Vaga:</strong> ${equipe.vaga}${equipe.vagaPersonalizada ? " - " + equipe.vagaPersonalizada : ""}</p>
            <p><strong>Equipamento:</strong> ${equipe.equipamento}${equipe.equipamentoPersonalizado ? " - " + equipe.equipamentoPersonalizado : ""}</p>
            <p><strong>Troca de Equipamento:</strong> ${equipe.trocaEquipamento}</p>
          </div>
        `;
        
        body.appendChild(principaisInfo);
        
        // Detalhes adicionais
        if (equipe.trocaEquipamento === 'Sim') {
          const trocaInfo = document.createElement('div');
          trocaInfo.className = 'alert alert-warning';
          
          let motivoText = equipe.motivoTroca;
          if (equipe.motivoTroca === 'Outros Motivos (Justificar)' && equipe.motivoOutro) {
            motivoText = equipe.motivoOutro;
          }
          
          trocaInfo.innerHTML = `
            <p><strong>Motivo da Troca:</strong> ${motivoText || 'Não especificado'}</p>
            ${equipe.defeito ? `<p><strong>Defeito:</strong> ${equipe.defeito}</p>` : ''}
            ${equipe.placaNova ? `<p><strong>Placa Nova:</strong> ${equipe.placaNova}</p>` : ''}
            ${equipe.dataHoraTroca ? `<p><strong>Data/Hora da Troca:</strong> ${equipe.dataHoraTroca}</p>` : ''}
          `;
          body.appendChild(trocaInfo);
        }
        
        card.appendChild(header);
        card.appendChild(body);
        resumoEquipes.appendChild(card);
      });
      
      // Avançar para próxima etapa
      document.getElementById('stepEquipes').style.display = 'none';
      document.getElementById('stepRevisao').style.display = 'block';
    }
    
    function voltarParaEquipes() {
      // Atualizar indicadores de etapa
      document.getElementById('step2Indicator').classList.add('active');
      document.getElementById('step2Indicator').classList.remove('completed');
      document.getElementById('step3Indicator').classList.remove('active');
      
      // Voltar para etapa anterior
      document.getElementById('stepRevisao').style.display = 'none';
      document.getElementById('stepEquipes').style.display = 'block';
    }
    
    function voltarParaSucesso() {
      document.getElementById('stepRelatorio').style.display = 'none';
      document.getElementById('stepSucesso').style.display = 'block';
    }
    
    function voltarDoWhatsApp() {
      document.getElementById('stepWhatsApp').style.display = 'none';
      document.getElementById('stepSucesso').style.display = 'block';
    }
    
    // Função melhorada para atualizar a lista de equipes
    function atualizarListaEquipes() {
      const listaEquipes = document.getElementById('listaEquipes');
      const semEquipes = document.getElementById('semEquipes');
      
      // Verificar se há equipes
      if (equipes.length === 0) {
        semEquipes.style.display = 'block';
        // Limpar lista, mantendo apenas o elemento semEquipes
        Array.from(listaEquipes.children).forEach(child => {
          if (child !== semEquipes) {
            listaEquipes.removeChild(child);
          }
        });
        return;
      }
      
      // Esconder mensagem de "sem equipes"
      semEquipes.style.display = 'none';
      
      // Limpar lista atual, exceto pelo elemento "semEquipes"
      Array.from(listaEquipes.children).forEach(child => {
        if (child !== semEquipes) {
          listaEquipes.removeChild(child);
        }
      });
      
      // Adicionar cada equipe à lista
      equipes.forEach((equipe, index) => {
        const equipeCard = document.createElement('div');
        equipeCard.className = 'card mb-3 equipe-card ' + (equipe.tipo === 'Auto Vácuo / Hiper Vácuo' ? 'equipe-vacuo' : '');
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        cardHeader.style.backgroundColor = equipe.tipo === 'Auto Vácuo / Hiper Vácuo' ? 'var(--danger-color)' : 'var(--primary-color)';
        
        const headerContent = document.createElement('div');
        headerContent.className = 'd-flex justify-content-between align-items-center';
        
        const titulo = document.createElement('h5');
        titulo.className = 'mb-0 text-white';
        titulo.textContent = equipe.tipo;
        titulo.innerHTML += ` <span class="badge-equipe">${equipe.numero}</span>`;
        
        const botoes = document.createElement('div');
        botoes.className = 'btn-group';
        
        const btnEditar = document.createElement('button');
        btnEditar.className = 'btn btn-sm btn-tool';
        btnEditar.innerHTML = '<i class="bi bi-pencil-square"></i> Editar';
        btnEditar.onclick = function() { editarEquipe(index); };
        
        const btnRemover = document.createElement('button');
        btnRemover.className = 'btn btn-sm btn-tool';
        btnRemover.innerHTML = '<i class="bi bi-trash"></i> Remover';
        btnRemover.onclick = function() { removerEquipe(index); };
        
        botoes.appendChild(btnEditar);
        botoes.appendChild(btnRemover);
        
        headerContent.appendChild(titulo);
        headerContent.appendChild(botoes);
        
        cardHeader.appendChild(headerContent);
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const detalhes = document.createElement('div');
        detalhes.className = 'row';
        
        // Coluna 1
        const col1 = document.createElement('div');
        col1.className = 'col-md-4';
        col1.innerHTML = `
          <p><strong>Integrantes:</strong> ${equipe.integrantes}</p>
          <p><strong>Área:</strong> ${equipe.area}</p>
          <p><strong>Atividade:</strong> ${equipe.atividade}</p>
        `;
        
        // Coluna 2
        const col2 = document.createElement('div');
        col2.className = 'col-md-4';
        
        // Vaga com suporte para personalizada
        let vagaText = equipe.vaga;
        if (equipe.vaga === 'OUTRA VAGA' && equipe.vagaPersonalizada) {
          vagaText += ` - ${equipe.vagaPersonalizada}`;
        }
        
        // Equipamento com suporte para personalizado
        let equipText = equipe.equipamento;
        if (equipe.equipamento === 'OUTRO EQUIPAMENTO' && equipe.equipamentoPersonalizado) {
          equipText += ` - ${equipe.equipamentoPersonalizado}`;
        }
        
        col2.innerHTML = `
          <p><strong>Vaga:</strong> ${shortenText(vagaText, 30)}</p>
          <p><strong>Equipamento:</strong> ${shortenText(equipText, 30)}</p>
          <p><strong>Troca de Equipamento:</strong> ${equipe.trocaEquipamento}</p>
        `;
        
        // Coluna 3
        const col3 = document.createElement('div');
        col3.className = 'col-md-4';
        col3.innerHTML = `
          <p><strong>Caixa de Bloqueio:</strong> ${equipe.caixaBloqueio}</p>
          <p><strong>Cadeados:</strong> ${equipe.cadeados}</p>
          <p><strong>Plaquetas:</strong> ${equipe.plaquetas}</p>
        `;
        
        detalhes.appendChild(col1);
        detalhes.appendChild(col2);
        detalhes.appendChild(col3);
        
        cardBody.appendChild(detalhes);
        
        // Adicionar informações extras se houver troca de equipamento
        if (equipe.trocaEquipamento === 'Sim') {
          const trocaInfo = document.createElement('div');
          trocaInfo.className = 'alert alert-warning mt-3 mb-0';
          
          let motivoText = equipe.motivoTroca;
          if (equipe.motivoTroca === 'Outros Motivos (Justificar)' && equipe.motivoOutro) {
            motivoText = equipe.motivoOutro;
          }
          
          trocaInfo.innerHTML = `<strong>Troca de equipamento:</strong> ${motivoText || 'Motivo não especificado'}`;
          cardBody.appendChild(trocaInfo);
        }
        
        equipeCard.appendChild(cardHeader);
        equipeCard.appendChild(cardBody);
        
        listaEquipes.appendChild(equipeCard);
      });
      
      // Verificar novamente se o botão de avançar deve ser habilitado
      atualizarBotaoAvancar();
    }
    
    function atualizarBotaoAvancar() {
      const btnAvancarRevisao = document.getElementById('btnAvancarRevisao');
      btnAvancarRevisao.disabled = equipes.length === 0;
    }
    
    // Funções auxiliares
    function shortenText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    function formatarData(dataStr) {
      if (!dataStr) return '';
      
      const data = new Date(dataStr);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      
      return `${dia}/${mes}/${ano}`;
    }
    
    // Funções para salvar e visualizar relatório
    function salvarRelatorio() {
      if (equipes.length === 0) {
        alert('Adicione pelo menos uma equipe antes de salvar o relatório.');
        return;
      }
      
      mostrarLoading('Salvando relatório...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            ultimoRelatorioId = result.relatorioId;
            
            // Atualizar indicadores de etapa
            document.getElementById('step3Indicator').classList.remove('active');
            document.getElementById('step3Indicator').classList.add('completed');
            
            // Avançar para tela de sucesso
            document.getElementById('stepRevisao').style.display = 'none';
            document.getElementById('stepSucesso').style.display = 'block';
          } else {
            alert('Erro ao salvar relatório: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .salvarTurno(window.dadosTurno, equipes);
    }
    
    function visualizarRelatorio() {
      if (!ultimoRelatorioId) {
        alert('ID do relatório não encontrado.');
        return;
      }
      
      mostrarLoading('Gerando relatório...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            document.getElementById('relatorioTexto').textContent = result.relatorio;
            document.getElementById('stepSucesso').style.display = 'none';
            document.getElementById('stepRelatorio').style.display = 'block';
          } else {
            alert('Erro ao gerar relatório: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .gerarRelatorioTexto(ultimoRelatorioId);
    }
    
    function copiarRelatorio() {
      const relatorioTexto = document.getElementById('relatorioTexto');
      const texto = relatorioTexto.textContent;
      
      // Tentar múltiplos métodos de cópia, do mais moderno ao mais compatível
      function mostrarSucesso() {
        mostrarNotificacao('Relatório copiado com sucesso!');
      }
      
      // Método 1: API Clipboard moderna
      try {
        navigator.clipboard.writeText(texto)
          .then(() => {
            mostrarSucesso();
            return true;
          })
          .catch(() => {
            // Se falhar, tenta método 2
            usarMetodoFallback();
          });
      } catch (e) {
        // Se método 1 não estiver disponível, tenta método 2
        usarMetodoFallback();
      }
      
      // Método 2: execCommand (compatibilidade)
      function usarMetodoFallback() {
        try {
          // Criar elemento temporário
          const textarea = document.createElement('textarea');
          textarea.value = texto;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          
          // Selecionar e copiar
          textarea.select();
          textarea.setSelectionRange(0, 99999); // Para mobile
          const sucesso = document.execCommand('copy');
          
          // Limpar
          document.body.removeChild(textarea);
          
          if (sucesso) {
            mostrarSucesso();
          } else {
            // Se ainda falhar, mostra interface alternativa
            mostrarAlternativa();
          }
        } catch (e) {
          mostrarAlternativa();
        }
      }
      
      // Método 3: Interface alternativa se tudo falhar
      function mostrarAlternativa() {
        // Criar modal ou diálogo para ajudar o usuário
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'modalCopiarAlternativo';
        modal.setAttribute('tabindex', '-1');
        modal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Copiar Relatório</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Selecione todo o texto abaixo e copie manualmente (usando o menu de contexto ou Ctrl+C):</p>
                <textarea class="form-control" rows="10" id="textoParaCopiar" onclick="this.select()">${texto}</textarea>
                
                <div class="d-flex justify-content-center mt-3" id="compartilharBtn">
                  <button class="btn btn-outline-primary" onclick="compartilharTexto()">
                    <i class="bi bi-share"></i> Compartilhar Texto
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Adicionar função de compartilhamento
        window.compartilharTexto = function() {
          if (navigator.share) {
            navigator.share({
              title: 'Relatório de Turno',
              text: texto
            })
            .catch(console.error);
          }
        };
        
        // Verificar se Web Share API está disponível (principalmente para mobile)
        if (!navigator.share) {
          document.getElementById('compartilharBtn').style.display = 'none';
        }
        
        // Exibir o modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Selecionar texto automaticamente
        setTimeout(() => {
          const textArea = document.getElementById('textoParaCopiar');
          textArea.select();
        }, 300);
      }
    }
    
    // Funções para os diferentes formatos de relatório
    function gerarPDF() {
      mostrarLoading('Gerando PDF...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            // Abrir o PDF em nova aba
            window.open(result.pdfUrl, '_blank');
            mostrarNotificacao('PDF gerado com sucesso!');
          } else {
            alert('Erro ao gerar PDF: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .gerarPDFRelatorio(ultimoRelatorioId);
    }
    
    function exportarPlanilha() {
      mostrarLoading('Exportando para planilha...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            // Abrir a planilha em nova aba
            window.open(result.planilhaUrl, '_blank');
            mostrarNotificacao('Planilha exportada com sucesso!');
          } else {
            alert('Erro ao exportar para planilha: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .exportarParaPlanilha(ultimoRelatorioId);
    }
    
    function formatarWhatsApp() {
      mostrarLoading('Formatando para WhatsApp...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            document.getElementById('whatsAppTexto').textContent = result.relatorio;
            document.getElementById('stepSucesso').style.display = 'none';
            document.getElementById('stepWhatsApp').style.display = 'block';
          } else {
            alert('Erro ao formatar para WhatsApp: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .formatarRelatorioWhatsApp(ultimoRelatorioId);
    }
    
    function copiarWhatsApp() {
      const whatsAppTexto = document.getElementById('whatsAppTexto');
      const texto = whatsAppTexto.textContent;
      
      // Tentar múltiplos métodos de cópia
      function mostrarSucesso() {
        mostrarNotificacao('Texto copiado com sucesso! Cole no WhatsApp.');
      }
      
      // Método 1: API Clipboard moderna
      try {
        navigator.clipboard.writeText(texto)
          .then(() => {
            mostrarSucesso();
            return true;
          })
          .catch(() => {
            // Se falhar, tenta método 2
            usarMetodoFallback();
          });
      } catch (e) {
        // Se método 1 não estiver disponível, tenta método 2
        usarMetodoFallback();
      }
      
      // Método 2: execCommand (compatibilidade)
      function usarMetodoFallback() {
        try {
          // Criar elemento temporário
          const textarea = document.createElement('textarea');
          textarea.value = texto;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          
          // Selecionar e copiar
          textarea.select();
          textarea.setSelectionRange(0, 99999); // Para mobile
          const sucesso = document.execCommand('copy');
          
          // Limpar
          document.body.removeChild(textarea);
          
          if (sucesso) {
            mostrarSucesso();
          } else {
            // Se ainda falhar, mostra interface alternativa
            mostrarAlternativa();
          }
        } catch (e) {
          mostrarAlternativa();
        }
      }
      
      // Método 3: Interface alternativa
      function mostrarAlternativa() {
        // Usar a API Web Share se disponível (principalmente em mobile)
        if (navigator.share) {
          navigator.share({
            title: 'Relatório de Turno - WhatsApp',
            text: texto
          })
          .then(() => {
            mostrarSucesso();
          })
          .catch((error) => {
            console.error('Erro ao compartilhar:', error);
            alert('Não foi possível copiar ou compartilhar automaticamente. Por favor, selecione o texto manualmente e copie.');
          });
        } else {
          // Destacar o texto para facilitar a seleção manual
          whatsAppTexto.focus();
          whatsAppTexto.select();
          alert('Selecione o texto manualmente e copie (Ctrl+C ou Menu de contexto)');
        }
      }
    }
    
    function novoRelatorio() {
      // Confirmar com o usuário
      if (!confirm('Deseja iniciar um novo relatório? Os dados do relatório atual não poderão ser editados.')) {
        return;
      }
      
      // Resetar formulários
      document.getElementById('formTurno').reset();
      document.getElementById('formTurno').classList.remove('was-validated');
      document.getElementById('data').valueAsDate = new Date();
      
      // Limpar equipes
      equipes = [];
      atualizarListaEquipes();
      atualizarBotaoAvancar();
      
      // Resetar indicadores de etapa
      document.getElementById('step1Indicator').classList.add('active');
      document.getElementById('step1Indicator').classList.remove('completed');
      document.getElementById('step2Indicator').classList.remove('active');
      document.getElementById('step2Indicator').classList.remove('completed');
      document.getElementById('step3Indicator').classList.remove('active');
      document.getElementById('step3Indicator').classList.remove('completed');
      
      // Voltar para a primeira etapa
      document.getElementById('stepSucesso').style.display = 'none';
      document.getElementById('stepTurno').style.display = 'block';
    }
    
    // Funções para pesquisa de relatórios
    function ajustarCampoPesquisa() {
      const tipoPesquisa = document.getElementById('tipoPesquisa').value;
      const termoPesquisa = document.getElementById('termoPesquisa');
      const labelPesquisa = document.getElementById('labelPesquisa');
      
      switch(tipoPesquisa) {
        case 'data':
          labelPesquisa.textContent = 'Data (DD/MM/AAAA)';
          termoPesquisa.type = 'date';
          break;
        case 'mes_ano':
          labelPesquisa.textContent = 'Mês/Ano (MM/AAAA)';
          termoPesquisa.type = 'month';
          break;
        case 'supervisor':
          labelPesquisa.textContent = 'Nome do supervisor';
          termoPesquisa.type = 'text';
          break;
        case 'letra':
          labelPesquisa.textContent = 'Letra do turno';
          termoPesquisa.type = 'text';
          break;
        case 'geral':
        default:
          labelPesquisa.textContent = 'Termo de pesquisa';
          termoPesquisa.type = 'text';
          break;
      }
    }
    
    function abrirPesquisa() {
      // Mostrar a tela de pesquisa
      document.getElementById('stepTurno').style.display = 'none';
      document.getElementById('stepPesquisa').style.display = 'block';
      
      // Esconder resultados anteriores
      document.getElementById('resultadosPesquisa').style.display = 'none';
      document.getElementById('semResultados').style.display = 'none';
      
      // Resetar o formulário
      document.getElementById('formPesquisa').reset();
      ajustarCampoPesquisa();
    }
    
    function voltarDaPesquisa() {
      document.getElementById('stepPesquisa').style.display = 'none';
      document.getElementById('stepTurno').style.display = 'block';
    }
    
    function executarPesquisa() {
      const tipoPesquisa = document.getElementById('tipoPesquisa').value;
      let termoPesquisa = document.getElementById('termoPesquisa').value.trim();
      
      if (!termoPesquisa) {
        alert('Por favor, informe um termo de pesquisa.');
        return;
      }
      
      // Formatar o termo conforme o tipo de pesquisa
      if (tipoPesquisa === 'mes_ano') {
        // Converter formato YYYY-MM para MM/YYYY
        const partes = termoPesquisa.split('-');
        if (partes.length === 2) {
          termoPesquisa = partes[1] + '/' + partes[0];
        }
      }
      
      mostrarLoading('Pesquisando relatórios...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            // Mostrar área de resultados
            document.getElementById('resultadosPesquisa').style.display = 'block';
            
            // Limpar resultados anteriores
            const tabelaResultados = document.getElementById('tabelaResultados');
            tabelaResultados.innerHTML = '';
            
            if (result.resultados.length === 0) {
              // Mostrar mensagem de sem resultados
              document.getElementById('semResultados').style.display = 'block';
            } else {
              // Ocultar mensagem de sem resultados
              document.getElementById('semResultados').style.display = 'none';
              
              // Adicionar cada relatório encontrado à tabela
              result.resultados.forEach(function(relatorio) {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                  <td>${relatorio.data}</td>
                  <td>${relatorio.horario}</td>
                  <td>${relatorio.letra}</td>
                  <td>${relatorio.supervisor}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-primary" onclick="visualizarRelatorioExistente('${relatorio.id}')">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button type="button" class="btn btn-danger" onclick="gerarPDFRelatorioExistente('${relatorio.id}')">
                        <i class="bi bi-file-pdf"></i>
                      </button>
                      <button type="button" class="btn btn-success" onclick="exportarPlanilhaExistente('${relatorio.id}')">
                        <i class="bi bi-file-spreadsheet"></i>
                      </button>
                      <button type="button" class="btn btn-info" onclick="formatarWhatsAppExistente('${relatorio.id}')">
                        <i class="bi bi-whatsapp"></i>
                      </button>
                    </div>
                  </td>
                `;
                
                tabelaResultados.appendChild(tr);
              });
            }
          } else {
            alert('Erro na pesquisa: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .pesquisarRelatorios(termoPesquisa, tipoPesquisa);
    }
    
    // Funções para manipular relatórios existentes
    function visualizarRelatorioExistente(relatorioId) {
      mostrarLoading('Carregando relatório...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            document.getElementById('relatorioTexto').textContent = result.relatorio;
            document.getElementById('stepPesquisa').style.display = 'none';
            document.getElementById('stepRelatorio').style.display = 'block';
            
            // Atualizar botão de voltar
            document.getElementById('btnVoltarRelatorio').setAttribute('onclick', 'voltarParaPesquisa()');
          } else {
            alert('Erro ao carregar relatório: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .gerarRelatorioTexto(relatorioId);
    }
    
    function voltarParaPesquisa() {
      document.getElementById('stepRelatorio').style.display = 'none';
      document.getElementById('stepPesquisa').style.display = 'block';
    }
    
    function gerarPDFRelatorioExistente(relatorioId) {
      mostrarLoading('Gerando PDF...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            window.open(result.pdfUrl, '_blank');
            mostrarNotificacao('PDF gerado com sucesso!');
          } else {
            alert('Erro ao gerar PDF: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .gerarPDFRelatorio(relatorioId);
    }
    
    function exportarPlanilhaExistente(relatorioId) {
      mostrarLoading('Exportando para planilha...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            window.open(result.planilhaUrl, '_blank');
            mostrarNotificacao('Planilha exportada com sucesso!');
          } else {
            alert('Erro ao exportar para planilha: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .exportarParaPlanilha(relatorioId);
    }
    
    function formatarWhatsAppExistente(relatorioId) {
      mostrarLoading('Formatando para WhatsApp...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarLoading();
          
          if (result.success) {
            document.getElementById('whatsAppTexto').textContent = result.relatorio;
            document.getElementById('stepPesquisa').style.display = 'none';
            document.getElementById('stepWhatsApp').style.display = 'block';
            
            // Atualizar botão de voltar
            document.getElementById('btnVoltarWhatsApp').setAttribute('onclick', 'voltarDeWhatsAppParaPesquisa()');
          } else {
            alert('Erro ao formatar para WhatsApp: ' + result.message);
          }
        })
        .withFailureHandler(tratarErro)
        .formatarRelatorioWhatsApp(relatorioId);
    }
    
    function voltarDeWhatsAppParaPesquisa() {
      document.getElementById('stepWhatsApp').style.display = 'none';
      document.getElementById('stepPesquisa').style.display = 'block';
      
      // Resetar botão de voltar para comportamento padrão
      document.getElementById('btnVoltarWhatsApp').setAttribute('onclick', 'voltarDoWhatsApp()');
    }
    
    // Função para mostrar ajuda
    function mostrarHelp() {
      if (modalHelp) {
        modalHelp.show();
      } else {
        // Tentar inicializar novamente
        try {
          modalHelp = new bootstrap.Modal(document.getElementById('modalHelp'));
          modalHelp.show();
        } catch (err) {
          console.error("Erro ao mostrar modal de ajuda:", err);
          alert("O sistema de ajuda não está disponível no momento. Tente recarregar a página.");
        }
      }
    }
    
    // Função para diagnóstico
    function executarDiagnostico() {
      if (confirm('Deseja executar o diagnóstico do sistema? Isso criará dados de teste na planilha.')) {
        mostrarLoading('Executando diagnóstico...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            ocultarLoading();
            
            if (result.success) {
              var mensagem = "Diagnóstico concluído!\n\n" + result.message;
              if (result.planilhaUrl) {
                mensagem += "\n\nClique em OK para abrir a planilha.";
                if (confirm(mensagem)) {
                  window.open(result.planilhaUrl, '_blank');
                }
              } else {
                alert(mensagem);
              }
            } else {
              alert('Erro no diagnóstico: ' + result.message);
            }
          })
          .withFailureHandler(tratarErro)
          .diagnosticarESolucionar();
      }
    }
    
    // Funções para notificações
    function mostrarNotificacao(mensagem) {
      const toast = document.getElementById('toastNotificacao');
      const toastTexto = document.getElementById('toastTexto');
      
      toastTexto.textContent = mensagem;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Funções de loading e tratamento de erros
    function mostrarLoading(mensagem = 'Processando, aguarde...') {
      const loading = document.querySelector('.loading');
      const loadingText = document.querySelector('.loading-text');
      loadingText.textContent = mensagem;
      loading.style.display = 'flex';
    }
    
    function ocultarLoading() {
      document.querySelector('.loading').style.display = 'none';
    }
    
    function tratarErro(erro) {
      ocultarLoading();
      console.error('Erro:', erro);
      alert('Ocorreu um erro: ' + erro);
    }
  </script>
</body>
</html>
